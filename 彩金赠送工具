# -*- coding: utf-8 -*-
import sys, time, random, configparser
from zoneinfo import ZoneInfo
import requests
import openpyxl
from PyQt5.QtCore import Qt, QRunnable, QThreadPool, QObject, pyqtSignal, QSize, QByteArray
from PyQt5.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, QGridLayout, QTextBrowser, QTextEdit,
    QGroupBox, QTableWidget, QTableWidgetItem, QHeaderView, QAbstractItemView,
    QLineEdit, QPushButton, QLabel, QProgressBar, QFileDialog, QMessageBox, QScrollArea,
    QCheckBox, QListWidget, QListWidgetItem, QStackedWidget, QFrame, QSizePolicy, QStyledItemDelegate, QComboBox
)
from PyQt5.QtGui import QPixmap, QIcon
from PyQt5.QtWidgets import QProxyStyle, QStyle
from datetime import datetime, timedelta, timezone
from PyQt5.QtGui import QColor, QBrush, QFont
import json


class InstantToolTipStyle(QProxyStyle):
    def styleHint(self, hint, option=None, widget=None, returnData=None):
        if hint == QStyle.SH_ToolTip_WakeUpDelay:
            return 0  # é¦–æ¬¡å»¶è¿Ÿï¼š0ms
        if hint == QStyle.SH_ToolTip_FallAsleepDelay:
            return 60000  # ä¼‘çœ å‰ä¿æŒâ€œå·²å”¤é†’â€ 60sï¼ˆæŒ‰éœ€ï¼‰
        return super().styleHint(hint, option, widget, returnData)


############################################
# 1) å¤ç”¨ä½ ç°æœ‰çš„ Workerï¼Œä¸æ”¹é€»è¾‘/ç­¾å
############################################

class WorkerSignals(QObject):
    progress = pyqtSignal(int)
    result = pyqtSignal(int, str)  # (row_idx, status)
    finished = pyqtSignal(list)  # logs


class SendGiftWorker(QRunnable):
    """
    æ´¾é€/æ‰£é™¤/æ‰£é’»çŸ³ å­çº¿ç¨‹ï¼š
    - mode="send"   ï¼šmoney=0,     gift_money=+é‡‘é¢, need_trade=ï¼ˆå¤–éƒ¨ä¼ ï¼š0 æˆ– é‡‘é¢ï¼‰
    - mode="deduct" ï¼šmoney=-é‡‘é¢,  gift_money=0,    need_trade=ï¼ˆå¤–éƒ¨ä¼ ï¼š0 æˆ– -é‡‘é¢ï¼‰
    - mode="diamond"ï¼šitem_count=-æ•°é‡ï¼ˆé’»çŸ³ï¼‰ï¼Œä¸æ¶‰åŠ money/gift_money/need_trade
    - ç»Ÿä¸€æŠŠæ¥å£åŸå§‹è¿”å›å½’ä¸€åŒ–ï¼š
        * æˆåŠŸ           -> 'æˆåŠŸ'
        * éªŒè¯è¢«æ‹’ç»     -> 'éªŒè¯è¢«æ‹’ç»'
        * è®¢å•è¶…æ—¶/timeout -> 'è®¢å•è¶…æ—¶'
      ä¸æ˜ç¡®æ—¶ï¼Œä»…å½“ confirm_each=True æ‰è½®è¯¢ç¡®è®¤ï¼ˆä½ å½“å‰åªå¯¹ â€œæ‰£é™¤å½©é‡‘â€ ä¼ äº† Trueï¼‰
    """

    def __init__(self, rows_data, mode: str = "send",
                 confirm_each: bool = False, confirm_timeout: int = 15, poll_interval: float = 1.0):
        super().__init__()
        self.rows_data = rows_data
        self.mode = mode
        self.confirm_each = confirm_each
        self.confirm_timeout = int(confirm_timeout)
        self.poll_interval = float(poll_interval)
        self.signals = WorkerSignals()
        self.logs = []
        self.is_running = True

    def stop(self):
        self.is_running = False

    def _extract_port_from_url(self, url: str) -> str:
        try:
            after_colon = url.split(':', 2)[2]  # "8080/xxx"
            return after_colon.split('/')[0]  # "8080"
        except Exception:
            return ""

    def _poll_confirm_once(self, session, headers, appid, cjmc, login_code, port) -> bool:
        """ä¸€æ¬¡è½®è¯¢ç¡®è®¤ï¼›ç”±è°ƒç”¨æ–¹å†³å®šæ˜¯å¦å¼€å¯ã€‚"""
        if not port:
            return False
        poll_url = f"http://v.boinht.com:{port}/payment_log/list_payment_log"
        now_ts = int(time.time())
        payload = {
            "page_size": 60, "page": 1,
            "channel_id": "", "open_channel_id": "",
            "is_pay": "1", "send_item_time": "1",
            "begin_time": now_ts - 60, "end_time": now_ts + 60,
            "is_first_recharge": 0, "payment_class_id": "",
            "nickname": "", "order_id": "", "out_order_id": "",
            "money_type": 1, "oper_user": "",
            "content": cjmc, "content2": "", "content_list": "",
            "min_money": "", "max_money": "",
            "login_code": login_code, "user_id": appid,
        }
        try:
            r = session.post(poll_url, data=payload, headers=headers, timeout=(5, 10))
            if r.status_code == 200:
                result = r.json().get("result", []) or []
                return bool(result)
        except Exception:
            pass
        return False

    @staticmethod
    def _map_immediate_status(js, raw_status: str):
        """
        ç»Ÿä¸€è§£ææ¥å£å³æ—¶è¿”å›ï¼š
        è¿”å›ï¼š'æˆåŠŸ' / 'éªŒè¯è¢«æ‹’ç»' / 'è®¢å•è¶…æ—¶' / None(ä¸æ˜ç¡®)
        """
        msg_text, code_val = "", None
        if isinstance(js, dict):
            code_val = js.get("code")
            msg_text = str(js.get("msg", "") or "")
        else:
            msg_text = str(raw_status or "")
        msg_l = msg_text.lower()

        if code_val == 0 or ("æˆåŠŸ" in msg_text and "å¤±è´¥" not in msg_text):
            return "æˆåŠŸ"
        if ("éªŒè¯è¢«æ‹’ç»" in msg_text) or ("è¢«æ‹’ç»" in msg_text) or ("æ‹’ç»" in msg_text) or ("reject" in msg_l) or (
                "rejected" in msg_l):
            return "éªŒè¯è¢«æ‹’ç»"
        if ("è®¢å•è¶…æ—¶" in msg_text) or ("è¶…æ—¶" in msg_text) or ("timeout" in msg_l):
            return "è®¢å•è¶…æ—¶"
        return None

    def run(self):
        session = requests.Session()
        try:
            for index, (row_idx, appid, amount, liushui, login_code, cjmc, headers, url, group_name) in enumerate(
                    self.rows_data):
                if not self.is_running:
                    break

                # ç»Ÿä¸€æŠŠ amount è½¬æ­£ï¼ˆExcel ä¸€å¾‹å¡«æ­£æ•°ï¼‰
                try:
                    amt_num = int(float(str(amount)))
                    if amt_num < 0:
                        amt_num = abs(amt_num)
                except Exception:
                    amt_num = 0

                # === æ„é€  data ===
                if self.mode == "send":
                    data = {
                        "app_user_id": appid,
                        "money": "0",
                        "vip": "0",
                        "gift_money": str(amt_num),
                        "content": cjmc,
                        "password": "",
                        "need_trade": str(liushui),  # 0 æˆ– é‡‘é¢
                        "login_code": login_code,
                    }
                elif self.mode == "deduct":
                    data = {
                        "app_user_id": appid,
                        "money": f"-{amt_num}",
                        "vip": "0",
                        "gift_money": "0",
                        "content": cjmc,
                        "password": "",
                        "need_trade": str(liushui),  # 0 æˆ– -é‡‘é¢
                        "login_code": login_code,
                    }
                else:  # "diamond"
                    data = {
                        "item_id": "3",
                        "user_id": appid,
                        "item_count": f"-{amt_num}",
                        "password": "",
                        "desc": cjmc,
                        "login_code": login_code,
                    }

                # === å‘é€ ===
                js = None
                try:
                    resp = session.post(url, headers=headers, data=data, timeout=(10, 60))
                    try:
                        js = resp.json()
                        if isinstance(js, dict) and "code" in js:
                            raw_status = "æˆåŠŸ" if js.get("code") == 0 else (js.get("msg", "") or "å¤±è´¥")
                        else:
                            msg = js.get('msg', '') if isinstance(js, dict) else ''
                            raw_status = msg or 'æˆåŠŸ'
                    except Exception:
                        raw_status = (resp.text or '').strip() or 'æ¥å£æ— è¿”å›'
                except Exception as e:
                    raw_status = f"è¯·æ±‚å¤±è´¥: {e}"

                # === ç»Ÿä¸€å³æ—¶ç»“æœåˆ¤æ–­ï¼ˆä¸‰ç§æ¨¡å¼ç›¸åŒï¼‰===
                immediate = self._map_immediate_status(js, raw_status)

                # é»˜è®¤æ–‡æ¡ˆï¼ˆç”¨äºä¸æ˜ç¡®æ—¶ï¼‰
                fail_text = "èµ é€å¤±è´¥" if self.mode == "send" else ("æ‰£é™¤å¤±è´¥" if self.mode == "deduct" else "æ‰£é’»å¤±è´¥")
                display_status = immediate if immediate else (
                ("æˆåŠŸ" if ("æˆåŠŸ" in raw_status and "å¤±è´¥" not in raw_status) else fail_text))

                # æ˜¯å¦éœ€è¦è½®è¯¢ç¡®è®¤ï¼ˆä»…å½“è°ƒç”¨æ–¹ä¼ äº† confirm_each=True ä¸”å³æ—¶ç»“æœä¸æ˜ç¡®ï¼‰
                if (self.confirm_each is True) and (immediate is None) and self.is_running:
                    port = self._extract_port_from_url(url)
                    deadline = time.time() + self.confirm_timeout
                    confirmed = False
                    while self.is_running and time.time() < deadline:
                        if self._poll_confirm_once(session, headers, appid, cjmc, login_code, port):
                            confirmed = True
                            break
                        time.sleep(max(0.2, float(self.poll_interval)))
                    display_status = "æˆåŠŸ" if confirmed else "è®¢å•è¶…æ—¶"

                # === å›å†™ UI ä¸æ—¥å¿— ===
                log_entry = f"{group_name} | {appid} | {amount} | {cjmc} | {liushui} | {display_status}"
                self.logs.append(log_entry)
                self.signals.result.emit(row_idx, display_status)

                if not self.is_running:
                    break

                # ä»…èµ é€æ¨¡å¼é™é€Ÿï¼›æ‰£é™¤å½©é‡‘/æ‰£é’»çŸ³ä¸åšé¢å¤– sleepï¼ˆä¿æŒä½ åŸæ¥çš„å¹¶å‘/ä¸²è¡Œç­–ç•¥ï¼‰
                if self.mode == "send":
                    total_sleep = random.uniform(1, 3)
                    chunk = total_sleep / 10
                    for _ in range(10):
                        if not self.is_running:
                            break
                        time.sleep(chunk)

                if not self.is_running:
                    break
        finally:
            try:
                session.close()
            except Exception:
                pass
            self.signals.finished.emit(self.logs)


class RecheckPaymentWorker(QRunnable):
    """
    åŸæ ·å¤ç”¨ä½ çš„å¤æ ¸å­çº¿ç¨‹
    """

    def __init__(self, items, begin_ts: int, end_ts: int, retries: int = 3, delay_seconds: float = 5.0):
        super().__init__()
        self.items = items
        self.begin_ts = int(begin_ts)
        self.end_ts = int(end_ts)
        self.retries = int(retries)
        self.delay_seconds = float(delay_seconds)
        self.signals = WorkerSignals()
        self.logs = []
        self.is_running = True

    def stop(self):
        self.is_running = False

    def run(self):
        session = requests.Session()
        try:
            for it in self.items:
                if not self.is_running:
                    break

                row_idx = it["row_idx"]
                appid = it["appid"]
                cjmc = it["cjmc"]
                code = it["code"]
                port = it["port"]
                headers = it["headers"]
                group = it["group"]

                url = f"http://v.boinht.com:{port}/payment_log/list_payment_log"
                payload = {
                    "page_size": 60,
                    "page": 1,
                    "channel_id": "",
                    "open_channel_id": "",
                    "is_pay": "1",
                    "send_item_time": "1",
                    "begin_time": self.begin_ts,
                    "end_time": self.end_ts,
                    "is_first_recharge": 0,
                    "payment_class_id": "",
                    "nickname": "",
                    "order_id": "",
                    "out_order_id": "",
                    "money_type": 1,
                    "oper_user": "",
                    "content": cjmc,
                    "content2": "",
                    "content_list": "",
                    "min_money": "",
                    "max_money": "",
                    "login_code": code,
                    "user_id": appid,
                }

                found = False
                for attempt in range(1, self.retries + 1):
                    if not self.is_running:
                        break

                    try:
                        resp = session.post(url, data=payload, headers=headers, timeout=(5, 10))
                        if resp.status_code == 200:
                            result = resp.json().get("result", [])
                            if result:
                                found = True
                                break
                    except Exception:
                        pass

                    # åˆ†æ®µç­‰å¾…ï¼Œå¯ä¸­æ–­
                    wait = self.delay_seconds
                    chunk = max(0.2, wait / 10.0)
                    t = 0.0
                    while t < wait and self.is_running:
                        time.sleep(chunk)
                        t += chunk

                final_status = "å¤æ ¸æœ‰è®°å½•" if found else f"å¤æ ¸{self.retries}æ¬¡ä»å¤±è´¥"
                self.signals.result.emit(row_idx, final_status)
                self.logs.append(f"{group} | {appid} | {cjmc} | {final_status}")

                if not self.is_running:
                    break
        finally:
            try:
                session.close()
            except Exception:
                pass
            self.signals.finished.emit(self.logs)


class MailWorkerSignals(QObject):
    progress = pyqtSignal(str, int, int)  # (group_name, sent_count, total_count)
    result = pyqtSignal(str, str)  # (group_name, status_text)
    finished = pyqtSignal(list)  # logs(list[str])


class SendMailWorker(QRunnable):
    """
    æ¯ä¸ªå°ç»„ä¸€ä¸ª workerï¼Œä¸²è¡ŒæŒ‰æ‰¹(<=1000)å‘é€
    ä½¿ç”¨æ–°æ¥å£ï¼š/kefu/save_secretary_task_by_admin
    """
    SEND_DELAY_SECONDS = 60
    EXPIRE_DAYS = 7  # é»˜è®¤å€¼ï¼Œå®ä¾‹åŒ–æ—¶å¯è¢«ä¼ å…¥çš„ expire_days è¦†ç›–

    def __init__(self, group_name: str, appids: list, content: str, port: str, login_code: str, token: str, expire_days: int = None):
        super().__init__()
        self.group = group_name
        self.appids = [str(x).strip() for x in appids if str(x).strip()]
        self.content = content or ""
        self.port = str(port or "").strip()
        self.login_code = str(login_code or "").strip()
        self.token = str(token or "").strip()
        self.signals = MailWorkerSignals()
        self.is_running = True
        self.logs = []
        # âœ… ä¿å­˜æœ¬æ¬¡ä»»åŠ¡çš„æœ‰æ•ˆæœŸå¤©æ•°
        self.expire_days = int(expire_days) if expire_days else self.EXPIRE_DAYS

    def stop(self):
        self.is_running = False

    def _build_payload(self, user_ids_csv: str):
        """
        - send_at = å½“å‰æ—¶é—´ + SEND_DELAY_SECONDS
        - expire_at = å½“å‰æ—¶é—´ + expire_days å¤©
        """
        now = int(time.time())
        send_at = now + self.SEND_DELAY_SECONDS
        expire_at = now + self.expire_days * 24 * 60 * 60

        delta = [{"insert": f"{self.content}\n"}]
        content_delta_str = json.dumps(delta, ensure_ascii=False)

        payload = {
            "send_at": send_at,
            "expire_at": expire_at,
            "channel_id": self.group,
            "user_ids": user_ids_csv,
            "remark": "ç³»ç»Ÿé‚®ä»¶",
            "urls": "",
            "attachment_ids": "",
            "content": content_delta_str,
            "content_text": self.content,
            "login_code": self.login_code,
        }
        return payload


    def run(self):
        session = requests.Session()
        try:
            total = len(self.appids)
            sent = 0
            url = f"http://v.boinht.com:{self.port}/kefu/save_secretary_task_by_admin"
            headers = {"Cookie": f"token={self.token}"}

            # åˆ†æ‰¹ï¼šæ¯æ‰¹æœ€å¤š 1000 ä¸ª
            BATCH = 2000
            for i in range(0, total, BATCH):
                if not self.is_running:
                    break

                batch_list = self.appids[i:i + BATCH]
                user_ids_csv = ",".join(batch_list)
                payload = self._build_payload(user_ids_csv)

                status_text = ""
                try:
                    resp = session.post(url, data=payload, headers=headers, timeout=(10, 60), verify=False)
                    try:
                        js = resp.json()
                    except Exception:
                        js = None

                    if isinstance(js, dict):
                        code = js.get("code")
                        msg = js.get("msg", "")
                        if code == 0:
                            status_text = "æˆåŠŸ"
                        else:
                            status_text = f"å¤±è´¥ï¼š{msg or (resp.text or '')[:200]}"
                    else:
                        # å…œåº•ï¼šçº¯æ–‡æœ¬æˆåŠŸåˆ¤æ–­
                        txt = (resp.text or "").strip()
                        status_text = "æˆåŠŸ" if '"code":0' in txt.replace(" ", "") else f"å¤±è´¥ï¼š{txt[:200]}"

                except Exception as e:
                    status_text = f"å¤±è´¥ï¼šè¯·æ±‚å¼‚å¸¸ {e}"

                # æ‰¹æ¬¡æ—¥å¿—ï¼Œæºå¸¦ uidsï¼Œç”¨äºå¯¼å‡ºæ—¶å±•å¼€
                uids_csv = ",".join(batch_list)
                self.logs.append(
                    f"{self.group} | batch={i // BATCH + 1} | size={len(batch_list)} | uids={uids_csv} | {status_text}"
                )

                # è¿›åº¦
                if status_text.startswith("æˆåŠŸ"):
                    sent += len(batch_list)
                # å‘è¿›åº¦ä¿¡å·ï¼ˆæ¯æ‰¹ï¼‰
                self.signals.progress.emit(self.group, sent, total)

                if not self.is_running:
                    break

            # æ±‡æ€»ç»“æœ
            final = "æˆåŠŸ" if sent == total else f"éƒ¨åˆ†/å¤±è´¥ï¼š{sent}/{total}"
            self.signals.result.emit(self.group, final)
        finally:
            try:
                session.close()
            except Exception:
                pass
            self.signals.finished.emit(self.logs)


############################################
# 2) å·¥å…·å‡½æ•°ï¼šé…ç½® & é€šç”¨
############################################

def load_group_names_from_config():
    cfg = configparser.ConfigParser()
    cfg.read('config.ini', encoding='utf-8')

    names = []
    if cfg.has_section('GROUP_COOKIES'):
        names = list(cfg['GROUP_COOKIES'].keys())

    if not names and cfg.has_section('settings'):
        s = cfg['settings']
        if 'groups' in s:
            names += [g.strip() for g in s['groups'].split(',') if g.strip()]
        for key in s:
            if key.startswith('cookie_'):
                names.append(key[len('cookie_'):])
        names = list(dict.fromkeys(names))

    if not names:
        names = ['lvcha', 'yaoji', 'sejie', 'aisebo', 'xingf', 'shaonv', 'renqi', 'lemi', 'cshuang']

    return names


def read_common_and_cookies():
    """ä» config.ini è¯»å– [COMMON] ä¸ [GROUP_COOKIES]"""
    cfg = configparser.ConfigParser()
    cfg.read('config.ini', encoding='utf-8')
    common = {'port': '', 'code': ''}
    cookies = {}
    if cfg.has_section('COMMON'):
        common['port'] = cfg['COMMON'].get('port', '').strip()
        common['code'] = cfg['COMMON'].get('code', '').strip()
    if cfg.has_section('GROUP_COOKIES'):
        for k, v in cfg['GROUP_COOKIES'].items():
            cookies[k] = v.strip()
    return common, cookies


def save_log_to_excel(logs, mode: str = "send"):
    """
    å¯¼å‡ºæ—¥å¿—ï¼š
    - send   ï¼šå·¥ä½œç°¿å/è¡¨å¤´ä½¿ç”¨ã€èµ é€å½©é‡‘ã€‘ï¼›å«ã€Œå¤æ ¸æœ‰è®°å½•ã€ã€Œå¤±è´¥è®°å½•ã€
    - deduct ï¼šå·¥ä½œç°¿å/è¡¨å¤´ä½¿ç”¨ã€æ‰£é™¤å½©é‡‘ã€‘ï¼›å«ã€Œå¤æ ¸æœ‰è®°å½•ã€ã€Œå¤±è´¥è®°å½•ã€
    - diamondï¼šå·¥ä½œç°¿å/è¡¨å¤´ä½¿ç”¨ã€æ‰£é™¤é’»çŸ³ã€‘ï¼›ä»…ã€Œå¤±è´¥è®°å½•ã€ï¼ˆä¸å¤æ ¸ã€æ— æµæ°´ï¼‰
    - mail   ï¼šä»…ç”¨äºâ€œå°ç§˜ä¹¦â€å‘é€ç»“æœï¼›ä¸¤ä¸ªå·¥ä½œè¡¨ã€æ´¾é€æ—¥å¿—ã€‘ã€å¤±è´¥è®°å½•ã€‘
               æ—¥å¿—æ ¼å¼ï¼šgroup | batch=N | size=K | çŠ¶æ€
    """
    try:
        from openpyxl import Workbook
        import time

        timestamp = time.strftime("%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†%Sç§’")

        # === é‚®ä»¶æ—¥å¿—ï¼ˆè¿è¡Œæ—¶æŒ‰æ‰¹ï¼Œå¯¼å‡ºæŒ‰ APPID å±•å¼€ï¼‰===
        if mode == "mail":
            wb = Workbook()
            ws_all = wb.active
            ws_all.title = "æ´¾é€æ—¥å¿—"
            ws_all.append(["å°ç»„", "APPID", "çŠ¶æ€"])

            ws_fail = wb.create_sheet("å¤±è´¥è®°å½•")
            ws_fail.append(["å°ç»„", "APPID", "çŠ¶æ€"])

            for line in logs or []:
                # æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
                #  A) æ‰¹æ¬¡è¡Œï¼š group | batch=N | size=K | uids=1,2,3 | çŠ¶æ€
                #  B) é€äººè¡Œï¼š group | appid | çŠ¶æ€ï¼ˆå‘åå…¼å®¹ï¼‰
                parts = [x.strip() for x in str(line).split("|")]

                if len(parts) >= 5 and parts[3].startswith("uids="):
                    group = parts[0]
                    # uids=åé¢çš„æ•´ä¸²
                    uids_csv = parts[3].split("=", 1)[1].strip()
                    status = parts[4]
                    uids = [u.strip() for u in uids_csv.split(",") if u.strip()]
                    for uid in uids:
                        try:
                            uid_val = int(uid)
                        except Exception:
                            uid_val = uid
                        ws_all.append([group, uid_val, status])
                        if not str(status).startswith("æˆåŠŸ"):
                            ws_fail.append([group, uid_val, status])

                elif len(parts) >= 3:
                    group, appid, status = parts[:3]
                    try:
                        appid_val = int(appid)
                    except Exception:
                        appid_val = appid
                    ws_all.append([group, appid_val, status])
                    if not str(status).startswith("æˆåŠŸ"):
                        ws_fail.append([group, appid_val, status])

                # å…¶ä»–æ ¼å¼å¿½ç•¥

            filename = f"å°ç§˜ä¹¦å‘å¸ƒæ—¥å¿—_{timestamp}.xlsx"
            wb.save(filename)
            return filename

        # === ä¸‹é¢ä¿ç•™ä½ åŸæœ‰çš„ä¸‰ç§æ´¾é€/æ‰£é™¤/é’»çŸ³ ===
        if mode == "send":
            amount_col = "èµ é€é‡‘é¢"
            desc_col = "å½©é‡‘åç§°"
            book_title = "èµ é€å½©é‡‘æ—¥å¿—"
            with_liushui = True
        elif mode == "deduct":
            amount_col = "æ‰£é™¤é‡‘é¢"
            desc_col = "å½©é‡‘åç§°"
            book_title = "æ‰£é™¤å½©é‡‘æ—¥å¿—"
            with_liushui = True
        else:  # diamond
            amount_col = "æ‰£é™¤é’»çŸ³"
            desc_col = "å¤‡æ³¨"
            book_title = "æ‰£é™¤é’»çŸ³æ—¥å¿—"
            with_liushui = False  # é’»çŸ³ä¸æ¶‰åŠæµæ°´/å¤æ ¸

        wb = Workbook()

        # å·¥ä½œè¡¨1ï¼šå…¨éƒ¨æ—¥å¿—ï¼ˆæ´¾é€æ—¥å¿—ï¼‰
        ws_all = wb.active
        ws_all.title = book_title
        if with_liushui:
            ws_all.append(['å°ç»„', 'APPID', amount_col, desc_col, 'æµæ°´', 'çŠ¶æ€'])
        else:
            ws_all.append(['å°ç»„', 'APPID', amount_col, desc_col, 'çŠ¶æ€'])

        # å·¥ä½œè¡¨2ï¼ˆsend/deductï¼‰ï¼šå¤æ ¸æœ‰è®°å½•
        ws_recovered = None
        if with_liushui:
            ws_recovered = wb.create_sheet("å¤æ ¸æœ‰è®°å½•")
            ws_recovered.append(['å°ç»„', 'APPID', amount_col, desc_col, 'æµæ°´', 'æ´¾é€çŠ¶æ€', 'å¤æ ¸çŠ¶æ€'])

        # å·¥ä½œè¡¨æœ€åï¼šå¤±è´¥è®°å½•
        ws_fail = wb.create_sheet("å¤±è´¥è®°å½•")
        if with_liushui:
            ws_fail.append(['å°ç»„', 'APPID', amount_col, desc_col, 'æµæ°´', 'çŠ¶æ€'])
        else:
            ws_fail.append(['å°ç»„', 'APPID', amount_col, desc_col, 'çŠ¶æ€'])

        # === å¤æ ¸æ˜ å°„ï¼ˆä»… send/deduct ç”¨ï¼‰===
        recheck_map = {}
        if with_liushui:
            for log in logs or []:
                parts = [x.strip() for x in str(log).split('|')]
                if len(parts) == 4:
                    group, appid, cjmc, re_status = parts
                    recheck_map[(group, str(appid), cjmc)] = re_status

        # â€”â€”é€šç”¨è§£æï¼šå®¹å¿ 6 æ®µæˆ– 5 æ®µï¼ˆä¸ªåˆ«å®ç°å¯èƒ½ä¸å«â€œæµæ°´â€å ä½ï¼‰â€”â€”
        def parse_send_line(line: str):
            p = [x.strip() for x in str(line).split('|')]
            if len(p) >= 6:
                group, appid, amount, cjmc, liushui, status = p[:6]
            elif len(p) == 5:
                group, appid, amount, cjmc, status = p
                liushui = ""  # é’»çŸ³æ¨¡å¼å¯èƒ½æ— å ä½
            else:
                return None
            return group, appid, amount, cjmc, liushui, status

        def _to_int(x, default=0):
            try:
                return int(float(str(x)))
            except Exception:
                return default

        send_keys_seen = set()

        for log in logs or []:
            parsed = parse_send_line(log)
            if not parsed:
                continue

            group, appid, amount, cjmc, liushui, status = parsed

            appid_value = appid
            try:
                appid_value = int(appid)
            except Exception:
                pass
            amount_value = _to_int(amount, 0)
            liushui_value = _to_int(liushui, 0)

            # â‘  å…¨éƒ¨æ—¥å¿—
            if with_liushui:
                ws_all.append([group, appid_value, amount_value, cjmc, liushui_value, status])
            else:
                ws_all.append([group, appid_value, amount_value, cjmc, status])

            # â‘¡ å¤±è´¥æ—¥å¿—
            norm_status = (status or "").strip()
            is_success = norm_status.startswith("æˆåŠŸ")
            if not with_liushui:
                if not is_success:
                    ws_fail.append([group, appid_value, amount_value, cjmc, norm_status])
            else:
                key = (group, str(appid), cjmc)
                send_keys_seen.add(key)
                re_status = recheck_map.get(key, "")
                recovered = (re_status == "å¤æ ¸æœ‰è®°å½•")
                still_failed = (not is_success) and (not recovered)
                if still_failed:
                    fail_status = re_status or norm_status
                    ws_fail.append([group, appid_value, amount_value, cjmc, liushui_value, fail_status])

            # â‘¢ send/deductï¼šå¤æ ¸æœ‰è®°å½•
            if with_liushui:
                key = (group, str(appid), cjmc)
                re_status = recheck_map.get(key, "")
                if re_status == "å¤æ ¸æœ‰è®°å½•":
                    ws_recovered.append([group, appid_value, amount_value, cjmc, liushui_value, status, re_status])

        # â€”â€”è¡¥å……ï¼šåªæœ‰å¤æ ¸æ—¥å¿—ã€æ²¡æœ‰æ´¾é€æ—¥å¿—ï¼ˆsend/deductï¼‰â€”â€”
        if with_liushui:
            for key, re_status in recheck_map.items():
                if re_status != "å¤æ ¸æœ‰è®°å½•":
                    continue
                if key not in send_keys_seen:
                    group, appid, cjmc = key
                    try:
                        appid_value = int(appid)
                    except Exception:
                        appid_value = appid
                    ws_recovered.append([group, appid_value, "", cjmc, "", "æœªæ‰¾åˆ°æ´¾é€æ—¥å¿—", re_status])

        filename = f'{book_title}_{timestamp}.xlsx'
        wb.save(filename)
        return filename

    except Exception as e:
        raise RuntimeError(f"Excelæ—¥å¿—ä¿å­˜å¤±è´¥: {e}")


############################################
# 3) å‚æ•°é…ç½®é¡µ
############################################


class ParamsPage(QWidget):
    """
    å·¦ä¾§â€œå‚æ•°é…ç½®â€é¡µï¼šä¸Šæ–¹ä¸ºå¯æ»šåŠ¨çš„åˆ†ç»„ Cookieï¼Œåº•éƒ¨ä¸ºåŸºç¡€å‚æ•°
    è‡ªåŠ¨é€‚åº”å®½é«˜ï¼Œæ§ä»¶éšçª—å£æ‹‰ä¼¸
    """

    def __init__(self, parent=None):
        super().__init__(parent)
        self.group_names = load_group_names_from_config()
        self.group_inputs = {}

        # ===== è¯»å–é…ç½® =====
        common, cookies = read_common_and_cookies()

        # ===== åˆ†ç»„ Cookieï¼ˆæ”¾è¿› ScrollAreaï¼Œéšé«˜åº¦è‡ªé€‚åº”ï¼‰ =====
        cookie_group = QGroupBox("åˆ†ç»„ Cookie å‚æ•°")
        cookie_group.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Preferred)

        grid = QGridLayout()
        grid.setContentsMargins(12, 8, 12, 12)
        grid.setHorizontalSpacing(12)
        grid.setVerticalSpacing(8)

        ROWS_PER_COL = 8  # æ¯åˆ—æ”¾ 8 è¡Œï¼Œçª—å£å˜å®½æ—¶æ¯åˆ—ä¼šå˜å®½
        for i, name in enumerate(self.group_names):
            edit = QLineEdit()
            edit.setPlaceholderText(f"è¯·è¾“å…¥ {name} Cookie")
            edit.setText(cookies.get(name, ''))
            edit.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
            self.group_inputs[name] = edit

            row = i % ROWS_PER_COL
            col = i // ROWS_PER_COL

            line = QHBoxLayout()
            line.setContentsMargins(0, 0, 0, 0)
            lbl = QLabel(f"{name}ï¼š")
            lbl.setMinimumWidth(64)
            lbl.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
            line.addWidget(lbl)
            line.addWidget(edit)
            grid.addLayout(line, row, col)

        # æ¯åˆ—ç­‰æ¯”æ‹‰ä¼¸
        cols = (len(self.group_names) + ROWS_PER_COL - 1) // ROWS_PER_COL
        for c in range(cols):
            grid.setColumnStretch(c, 1)

        cookie_group.setLayout(grid)

        # ScrollArea åŒ…è£¹åˆ†ç»„åŒºåŸŸ
        cookie_scroll = QScrollArea()
        cookie_scroll.setWidget(cookie_group)
        cookie_scroll.setWidgetResizable(True)
        cookie_scroll.setFrameShape(QFrame.NoFrame)
        cookie_scroll.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)

        # ===== åŸºç¡€å‚æ•°ï¼ˆé€šç”¨ï¼‰ =====
        base_group = QGroupBox("åŸºç¡€å‚æ•°ï¼ˆé€šç”¨ï¼‰")
        base_group.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)

        self.port_input = QLineEdit()
        self.code_input = QLineEdit()
        self.save_btn = QPushButton("ğŸ’¾ ä¿å­˜é…ç½®")

        self.port_input.setPlaceholderText("è¯·è¾“å…¥ç«¯å£å·ï¼Œä¾‹å¦‚ï¼š8080")
        self.port_input.setText(common.get('port', ''))
        self.code_input.setPlaceholderText("è¯·è¾“å…¥å°æ˜è®¡ç®—å™¨ç™»å½•ç ")
        self.code_input.setText(common.get('code', ''))

        # è¾“å…¥æ¡†éšå®½åº¦æ‹‰ä¼¸
        for w in (self.port_input, self.code_input, self.save_btn):
            w.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)

        base_layout = QVBoxLayout()
        base_layout.setContentsMargins(12, 8, 12, 12)
        base_layout.setSpacing(10)
        base_layout.addLayout(self._pair("ğŸŒ ç«¯å£å·ï¼š", self.port_input))
        base_layout.addLayout(self._pair("ğŸ”¢ ç™»å½•ç ï¼š", self.code_input))
        base_group.setLayout(base_layout)

        # ===== é¡µé¢æ€»å¸ƒå±€ =====
        layout = QVBoxLayout(self)
        layout.setContentsMargins(12, 8, 12, 12)
        layout.setSpacing(12)
        layout.addWidget(cookie_scroll, 1)  # å æ®å‰©ä½™é«˜åº¦ï¼Œå¯æ»šåŠ¨
        layout.addWidget(base_group, 0)  # è´´åº•éƒ¨ï¼Œä¿æŒå†…å®¹é«˜åº¦

        layout.addSpacing(16)
        layout.addWidget(self.save_btn)

        # ä¿¡å·
        self.save_btn.clicked.connect(self.save_config)

    def _pair(self, label, widget):
        row = QHBoxLayout()
        row.setContentsMargins(0, 0, 0, 0)
        row.setSpacing(8)
        lbl = QLabel(label)
        lbl.setMinimumWidth(64)
        lbl.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
        row.addWidget(lbl)
        row.addWidget(widget, 1)
        return row

    def save_config(self):
        port = (self.port_input.text() or "").strip()
        code = (self.code_input.text() or "").strip()
        if not port or not code:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·å¡«å†™å®Œæ•´çš„é…ç½®ï¼ˆç«¯å£å· å’Œ å°æ˜ç ï¼‰ï¼")
            return

        cfg = configparser.ConfigParser()
        cfg['COMMON'] = {'port': port, 'code': code}

        cookies = {}
        missing = []
        for name, edit in self.group_inputs.items():
            token = (edit.text() or "").strip()
            if token:
                cookies[name] = token
                edit.setStyleSheet("")
            else:
                missing.append(name)
                edit.setStyleSheet("border: 1px solid red;")
        cfg['GROUP_COOKIES'] = cookies

        with open('config.ini', 'w', encoding='utf-8') as f:
            cfg.write(f)

        if missing:
            QMessageBox.information(self, "éƒ¨åˆ†ä¿å­˜æˆåŠŸ", "é…ç½®å·²ä¿å­˜ï¼Œä½†ä»¥ä¸‹å°ç»„æœªå¡«å†™ Cookieï¼š\n" + "ã€".join(missing))
        else:
            QMessageBox.information(self, "æç¤º", "âœ… é…ç½®å·²å®Œæ•´ä¿å­˜ï¼")

    def set_enabled(self, enabled: bool):
        """è¿è¡Œä¸­ç¦ç”¨ï¼›ç»“æŸåæ¢å¤ã€‚"""
        self.save_btn.setEnabled(enabled)
        self.port_input.setEnabled(enabled)
        self.code_input.setEnabled(enabled)
        for edit in self.group_inputs.values():
            edit.setEnabled(enabled)


############################################
# 4) èµ é€/æ‰£é™¤ å…±ç”¨é¡µé¢ï¼ˆæ¨¡å¼åŒ–ï¼‰
############################################

class GiftPage(QWidget):
    """
    å¯é…ç½®æ¨¡å¼çš„é¡µé¢ï¼š
    mode: "send"ï¼ˆèµ é€å½©é‡‘ï¼‰ / "deduct"ï¼ˆæ‰£é™¤å½©é‡‘ï¼‰ / "diamond"ï¼ˆæ‰£é™¤é’»çŸ³ï¼‰
    """

    # æ–°å¢ï¼šå‘é€é‚®ä»¶ç›®æ ‡ï¼ˆä»… APPIDï¼ŒæŒ‰å°ç»„åˆ†ç»„ï¼‰
    mailTargetsReady = pyqtSignal(dict)  # {"ç»„å": ["appid1","appid2", ...]}

    def __init__(self, mode: str = "send", parent=None,
                 params_page: QWidget = None,  # æ–°å¢ï¼šå‚æ•°é…ç½®é¡µå¼•ç”¨
                 nav: QListWidget = None,  # æ–°å¢ï¼šå·¦ä¾§å¯¼èˆªå¼•ç”¨
                 nav_params_index: int = 3):  # æ–°å¢ï¼šâ€œå‚æ•°é…ç½®â€åœ¨å¯¼èˆªä¸­çš„ç´¢å¼•
        super().__init__(parent)
        assert mode in ("send", "deduct", "diamond")
        self.mode = mode

        # ä¿å­˜å¼•ç”¨ï¼Œä¾› _set_enabled() ä½¿ç”¨
        self.params_page = params_page
        self.nav = nav
        self.nav_params_index = nav_params_index

        # è¿è¡Œæ—¶ç»Ÿè®¡
        self.total_accounts = 0
        self.total_amount = 0
        self.completed_count = 0
        self.task_finished_called = False
        self.task_stopped = False
        self.group_logs = []
        self.active_workers = []
        self.finished_workers = 0

        self.threadpool = QThreadPool()

        self.recheck_worker = None  # å½“å‰å¤æ ¸çº¿ç¨‹å¼•ç”¨
        self.in_recheck = False  # æ˜¯å¦å¤„äºå¤æ ¸é˜¶æ®µ

        # ===== è¡¨æ ¼ =====
        self.table = QTableWidget()
        self.table.setColumnCount(5)

        # è¡¨å¤´ï¼šæŒ‰æ¨¡å¼åˆ†åˆ«æ˜¾ç¤º
        if self.mode == "send":
            headers = ['å°ç»„', 'APPID', 'èµ é€é‡‘é¢', 'å½©é‡‘åç§°', 'çŠ¶æ€']
        elif self.mode == "deduct":
            headers = ['å°ç»„', 'APPID', 'æ‰£é™¤é‡‘é¢', 'å½©é‡‘åç§°', 'çŠ¶æ€']
        else:  # diamond
            headers = ['å°ç»„', 'APPID', 'æ‰£é™¤é’»çŸ³', 'å¤‡æ³¨', 'çŠ¶æ€']

        self.table.setHorizontalHeaderLabels(headers)
        self.table.verticalHeader().setVisible(False)

        # â€”â€”çŠ¶æ€åˆ—ï¼šäº¤äº’å®½åº¦ + é»˜è®¤æœ€å°å®½åº¦â€”â€”
        self._status_col = 4
        self._status_min_width = 150  # æƒ³æ›´å®½å°±æ”¹è¿™ä¸ªæ•°
        hh = self.table.horizontalHeader()
        hh.setSectionResizeMode(self._status_col, QHeaderView.Interactive)
        self.table.setColumnWidth(self._status_col, self._status_min_width)

        # å¯é€‰ï¼šç»™æ‰€æœ‰åˆ—ä¸€ä¸ªæœ€å°åˆ—å®½ï¼Œé¿å…è¿‡çª„ï¼ˆæŒ‰éœ€ä¿ç•™ï¼‰
        hh.setMinimumSectionSize(80)

        # ===== åŠŸèƒ½åŒº =====
        self.import_btn = QPushButton("ğŸ“ å¯¼å…¥appid")
        self.password_input = QLineEdit()
        self.password_input.setPlaceholderText("è¯·è¾“å…¥ç¡®è®¤å¯†ç ")

        self.no_code_checkbox = QCheckBox(
            "æ— éœ€æ‰“ç " if self.mode == "send" else ("æ‰£ç­‰é¢æ‰“ç " if self.mode == "deduct" else "ï¼ˆé’»çŸ³æ— éœ€é€‰é¡¹ï¼‰")
        )
        if self.mode == "diamond":
            self.no_code_checkbox.setVisible(False)  # é’»çŸ³æ¨¡å¼ä¸éœ€è¦è¯¥é€‰é¡¹

        self.action_btn = QPushButton(
            "ğŸš€ æ´¾é€å½©é‡‘" if self.mode == "send" else ("âš ï¸ æ‰£é™¤å½©é‡‘" if self.mode == "deduct" else "ğŸ’ æ‰£é™¤é’»çŸ³")
        )
        self.stop_btn = QPushButton("ğŸ›‘ åœæ­¢æ‰§è¡Œ")

        # â€”â€”å…³é”®ï¼šæ‰€æœ‰è¾“å…¥/æŒ‰é’®è®¾ç½®ä¸ºâ€œæ°´å¹³å¯æ‰©å±•â€â€”â€”
        for w in (self.import_btn, self.password_input, self.no_code_checkbox,
                  self.action_btn, self.stop_btn):
            w.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
        self.action_btn.setMinimumHeight(36)
        self.stop_btn.setMinimumHeight(36)

        func_group = QGroupBox("åŠŸèƒ½æ“ä½œ")
        func_group.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)

        # å·¦åˆ—ç”¨ Gridï¼šæ ‡ç­¾åˆ—å›ºå®šï¼Œæ§ä»¶åˆ—è‡ªé€‚åº”
        left_grid = QGridLayout()
        left_grid.setContentsMargins(0, 0, 0, 0)
        left_grid.setHorizontalSpacing(10)
        left_grid.setVerticalSpacing(8)
        left_grid.setColumnStretch(0, 0)  # æ ‡ç­¾åˆ—
        left_grid.setColumnStretch(1, 1)  # è¾“å…¥/æŒ‰é’®åˆ—è‡ªåŠ¨æ‰©å±•

        row_i = 0
        left_grid.addWidget(self.import_btn, row_i, 0, 1, 2);
        row_i += 1
        left_grid.addWidget(QLabel("ç¡®è®¤å¯†ç ï¼š"), row_i, 0)
        left_grid.addWidget(self.password_input, row_i, 1);
        row_i += 1
        if self.mode != "diamond":
            left_grid.addWidget(self.no_code_checkbox, row_i, 0, 1, 2);
            row_i += 1

        # === æ‰£é™¤é¡µé¢çš„æç¤ºæ¡ï¼ˆæ›´æ˜æ˜¾çš„â€œè­¦å‘Šâ€ä¸»é¢˜ï¼‰ï¼›é’»çŸ³ä¹Ÿç»™æç¤º ===
        if self.mode in ("deduct", "diamond"):
            if self.mode == "deduct":
                hint_text = ("å¯¼å…¥ã€æ‰£é™¤é‡‘é¢ã€‘ä¸€å¾‹å¡«æ­£æ•°ï¼ˆå¦‚ 10ï¼‰ï¼Œç³»ç»Ÿæäº¤æ—¶ä¼šè‡ªåŠ¨æŒ‰ -10 æ‰£æ¬¾ï¼›"
                             "æœªå‹¾é€‰ã€Œæ‰£ç­‰é¢æ‰“ç ã€â†’ æµæ°´ = 0ï¼›å‹¾é€‰å â†’ æµæ°´ = -é‡‘é¢ã€‚")
                self.hint_label = self._build_hint_label(hint_text, level="warning")
            else:  # diamond
                hint_text = ("å¯¼å…¥ã€æ‰£é™¤é’»çŸ³ã€‘ä¸€å¾‹å¡«æ­£æ•°ï¼ˆå¦‚ 10ï¼‰ï¼Œç³»ç»Ÿæäº¤æ—¶ä¼šè‡ªåŠ¨æŒ‰ -10 æ‰£é™¤ï¼›"
                             "è¯¥æ“ä½œæ— å¤æ ¸æµç¨‹ã€‚")
                self.hint_label = self._build_hint_label(hint_text, level="warning")

            left_grid.addWidget(self.hint_label, row_i, 0, 1, 2);
            row_i += 1

        # å³åˆ—ï¼šæŒ‰é’®ç«–æ’ï¼Œå®½åº¦éšå®¹å™¨å˜åŒ–
        right_col = QVBoxLayout()
        right_col.setContentsMargins(0, 0, 0, 0)
        right_col.setSpacing(8)
        right_col.addWidget(self.action_btn)
        right_col.addWidget(self.stop_btn)
        right_col.addStretch(1)

        # é¡¶å±‚ï¼šå·¦å³ä¸¤åˆ—ï¼Œè®¾ç½®ä¼¸å±•å› å­è®©å·¦åˆ—æ›´å®½ï¼Œå³åˆ—è´´å³
        func_layout = QHBoxLayout()
        func_layout.setContentsMargins(10, 8, 10, 8)
        func_layout.setSpacing(12)
        func_layout.addLayout(left_grid, 3)
        func_layout.addLayout(right_col, 2)
        func_group.setLayout(func_layout)

        # ===== ç»Ÿè®¡ä¸è¿›åº¦ =====
        self.stats_label = QLabel("0 / 0")
        self.progress_bar = QProgressBar()
        self.progress_bar.setAlignment(Qt.AlignCenter)

        # ä¸»å¸ƒå±€
        main_layout = QVBoxLayout()
        main_layout.addWidget(self.table)
        main_layout.addWidget(func_group)  # é“ºæ»¡åº•éƒ¨
        main_layout.addWidget(self.stats_label)
        main_layout.addWidget(self.progress_bar)
        self.setLayout(main_layout)

        # ä¿¡å·
        self.import_btn.clicked.connect(self.import_file)
        self.action_btn.clicked.connect(self.perform_action)
        self.stop_btn.clicked.connect(self.stop_action)
        self.no_code_checkbox.stateChanged.connect(self.no_code_toggled)

    def _pair(self, label, widget):
        h = QHBoxLayout()
        h.addWidget(QLabel(label))
        h.addWidget(widget)
        return h

    def _build_hint_label(self, text: str, level: str = "info") -> QLabel:
        """åˆ›å»ºä¸€æ¡å¸¦ä¸»é¢˜è‰²çš„æç¤ºæ¡ï¼šlevel in {'info','warning'}"""
        palettes = {
            "info": {"bg": "#eef6ff", "bd": "#93c5fd", "fg": "#1e3a8a"},  # æµ…è“ä¿¡æ¯
            "warning": {"bg": "#fff7ed", "bd": "#fdba74", "fg": "#9a3412"},  # æµ…æ©™è­¦å‘Š
        }
        p = palettes.get(level, palettes["info"])
        lbl = QLabel(f"<b>æç¤ºï¼š</b>{text}")
        lbl.setWordWrap(True)
        lbl.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
        lbl.setStyleSheet(
            f"QLabel {{"
            f" background:{p['bg']};"
            f" border:1px solid {p['bd']};"
            f" color:{p['fg']};"
            f" border-radius:6px;"
            f" padding:8px 10px;"
            f"}}"
        )
        return lbl

    def _update_deduct_hint_text(self):
        """å‹¾é€‰å˜åŒ–æ—¶æ›´æ–°æ‰£é™¤æç¤ºæ–‡æ¡ˆï¼ˆä»…æ‰£é™¤å½©é‡‘ç”¨ï¼‰"""
        if not hasattr(self, "hint_label"):
            return
        if self.mode == "deduct":
            if self.no_code_checkbox.isChecked():
                text = "å·²å‹¾é€‰ã€Œæ‰£ç­‰é¢æ‰“ç ã€ï¼Œæµæ°´ = -é‡‘é¢ï¼ˆä¾‹å¦‚é‡‘é¢ 10 â†’ æµæ°´ -10ï¼‰ã€‚"
            else:
                text = "æœªå‹¾é€‰ã€Œæ‰£ç­‰é¢æ‰“ç ã€ï¼Œæµæ°´ = 0ã€‚å¯¼å…¥ã€æ‰£é™¤é‡‘é¢ã€‘ä¸€å¾‹å¡«æ­£æ•°ï¼ˆå¦‚ 10ï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨æŒ‰ -10 æ‰£æ¬¾ã€‚"
            self.hint_label.setText(f"<b>æç¤ºï¼š</b>{text}")

    # =========== UI è¡Œä¸º ===========
    def no_code_toggled(self, state):
        if self.mode == "send":
            QMessageBox.information(self, "æç¤º",
                                    "å·²å¯ç”¨ã€æ— éœ€æ‰“ç ã€‘ï¼Œæµæ°´å°†ä¸º 0" if state == Qt.Checked
                                    else "å·²å…³é—­ã€æ— éœ€æ‰“ç ã€‘ï¼Œé»˜è®¤æ‰“ç ä¸ºèµ é€é‡‘é¢çš„ä¸€å€")
        elif self.mode == "deduct":
            QMessageBox.information(self, "æç¤º",
                                    "å·²å¯ç”¨ã€æ‰£ç­‰é¢æ‰“ç ã€‘ï¼Œæµæ°´ = -é‡‘é¢" if state == Qt.Checked
                                    else "å·²å…³é—­ã€æ‰£ç­‰é¢æ‰“ç ã€‘ï¼Œæµæ°´ = 0")
        else:
            pass  # é’»çŸ³æ— æ­¤é€‰é¡¹

    def _is_recheck_running(self) -> bool:
        """å¤æ ¸çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œ"""
        rw = getattr(self, 'recheck_worker', None)
        return bool(rw and getattr(rw, 'is_running', False))

    def _has_active_workers(self) -> bool:
        """æ´¾é€/æ‰£é™¤çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œ"""
        return any(getattr(w, 'is_running', False) for w in getattr(self, 'active_workers', []))

    def stop_action(self):
        """ä»…åœ¨ç¡®æœ‰ä»»åŠ¡/å¤æ ¸è¿è¡Œæ—¶æ‰å‘å‡ºåœæ­¢æŒ‡ä»¤å¹¶æ”¹UIï¼ˆä¸­æ–‡æŒ‰é’®ï¼šç¡®å®š/å–æ¶ˆï¼‰"""
        from PyQt5.QtWidgets import QMessageBox

        # å…ˆæ£€æµ‹æ˜¯å¦æœ‰éœ€è¦åœæ­¢çš„ä»»åŠ¡/å¤æ ¸
        to_stop = []
        if getattr(self, 'active_workers', None):
            for w in list(self.active_workers):
                if getattr(w, 'is_running', False):
                    to_stop.append(w)

        try:
            recheck_running = bool(self._is_recheck_running())
        except Exception:
            recheck_running = False

        if not to_stop and not recheck_running:
            QMessageBox.information(self, "æç¤º", "å½“å‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ã€‚")
            return

        # æœ‰ä»»åŠ¡åœ¨è·‘ -> å¼¹å‡ºä¸­æ–‡ç¡®è®¤å¯¹è¯æ¡†
        box = QMessageBox(self)
        box.setWindowTitle("ç¡®è®¤åœæ­¢")
        box.setText("ç¡®å®šè¦åœæ­¢å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å—ï¼Ÿ\nï¼ˆè¿›è¡Œä¸­çš„ä»»åŠ¡ä¼šå°½å¿«åœæ­¢ï¼‰")
        box.setIcon(QMessageBox.Question)
        box.setStandardButtons(QMessageBox.Yes | QMessageBox.No)
        # æ”¹æŒ‰é’®æ–‡å­—ä¸ºä¸­æ–‡
        box.button(QMessageBox.Yes).setText("ç¡®å®š")
        box.button(QMessageBox.No).setText("å–æ¶ˆ")
        box.setDefaultButton(QMessageBox.Yes)
        box.exec_()
        if box.result() != QMessageBox.Yes:
            return  # ç”¨æˆ·å–æ¶ˆ

        # åœæ´¾é€/æ‰£é™¤çº¿ç¨‹
        for w in to_stop:
            try:
                w.stop()
            except Exception:
                pass

        # åœå¤æ ¸çº¿ç¨‹
        if recheck_running:
            try:
                if hasattr(self, "recheck_worker") and self.recheck_worker:
                    self.recheck_worker.stop()  # å…¶å†…éƒ¨ä¼šå°† is_running = False
            except Exception:
                pass

        # æ ‡è®°ä¸æ›´æ–° UI
        self.task_stopped = True

        # ä»…æŠŠâ€œå¾…å¤„ç†â€æ ‡ä¸ºâ€œå·²åœæ­¢â€ï¼ˆä¸ä¿®æ”¹å·²æ‰§è¡Œ/å·²å¤±è´¥çš„è¡Œï¼‰
        try:
            if hasattr(self, "table") and self.table is not None:
                for row in range(self.table.rowCount()):
                    status_item = self.table.item(row, 4)
                    if status_item and status_item.text().strip() == 'å¾…å¤„ç†':
                        status_item.setText('å·²åœæ­¢')
        except Exception:
            pass

        # çŠ¶æ€æç¤ºï¼šåŒºåˆ†æ˜¯å¦å¤„äºå¤æ ¸
        try:
            if hasattr(self, "stats_label") and self.stats_label is not None:
                if recheck_running:
                    self.stats_label.setText("å·²å‘é€åœæ­¢æŒ‡ä»¤ï¼ˆå¤æ ¸ï¼‰ï¼Œç­‰å¾…ä»»åŠ¡ç»“æŸâ€¦")
                else:
                    self.stats_label.setText("å·²å‘é€åœæ­¢æŒ‡ä»¤ï¼Œç­‰å¾…ä»»åŠ¡ç»“æŸâ€¦")
        except Exception:
            pass

        # é˜²æ­¢é‡å¤ç‚¹å‡»ï¼Œå¾… finished å›è°ƒé‡Œå†æ¢å¤
        try:
            if hasattr(self, "stop_btn") and self.stop_btn is not None:
                self.stop_btn.setEnabled(False)
        except Exception:
            pass

    # ========= æ–°å¢ï¼šä»…æ”¶é›† APPID çš„å·¥å…·å‡½æ•° & å‘é€é‚®ä»¶ç¡®è®¤ =========
    def _build_mail_targets_from_logs(self) -> dict:
        """
        é‡‡é›†æœ¬æ¬¡ã€èµ é€å½©é‡‘ã€æ‰§è¡Œåçš„â€œæœ€ç»ˆæˆåŠŸå£å¾„â€è´¦å·ï¼ˆç”¨äºé‚®ä»¶å‘é€ï¼‰ã€‚
        æ¥æºï¼šå½“å‰è¡¨æ ¼ç¬¬5åˆ—çŠ¶æ€ï¼ˆçŠ¶æ€ä¸ºâ€œæˆåŠŸâ€æˆ–â€œå¤æ ¸æœ‰è®°å½•â€ï¼‰ã€‚
        ä»…åœ¨ send æ¨¡å¼ç”Ÿæ•ˆï¼›æŒ‰å°ç»„åˆ†ç»„ï¼Œä¿ç•™é‡å¤ä¸é¡ºåºã€‚
        è¿”å›ï¼š{"å°ç»„A": ["123","123","456"], ...}
        """
        targets = {}
        if self.mode != "send":
            return targets

        for row in range(self.table.rowCount()):
            status_item = self.table.item(row, 4)
            if not status_item:
                continue
            status = (status_item.text() or "").strip()
            if status not in ("æˆåŠŸ", "å¤æ ¸æœ‰è®°å½•"):
                continue

            group = (self.table.item(row, 0).text() or "").strip()
            appid = (self.table.item(row, 1).text() or "").strip()
            if group and appid:
                # ä¿ç•™é‡å¤ï¼Œä¸å»é‡
                targets.setdefault(group, []).append(appid)

        return targets

    def _maybe_prompt_send_mail(self):
        """
        åœ¨èµ é€å½©é‡‘â€œçœŸæ­£å®Œæˆâ€åè°ƒç”¨ï¼š
        1) ç»„è£…æŒ‰ç»„çš„ APPID æ¸…å•ï¼›
        2) è‹¥ä¸ºç©ºåˆ™ä¸åŠ¨ä½œï¼›
        3) å¼¹çª—ç¡®è®¤ï¼›è‹¥é€‰æ‹©â€œæ˜¯â€ï¼Œå‘å°„ mailTargetsReadyï¼Œå¹¶åˆ‡æ¢åˆ°â€œé‚®ä»¶åˆ—è¡¨â€é¡µï¼ˆç´¢å¼• 3ï¼‰ã€‚
        """
        if self.mode != "send":
            return
        targets = self._build_mail_targets_from_logs()
        if not targets:
            return

        total_accounts = sum(len(v) for v in targets.values())
        # è‡ªå®šä¹‰æŒ‰é’®æ–‡å­—çš„è¯¢é—®æ¡†
        msg = QMessageBox(QMessageBox.Question, "å‘å¸ƒå°ç§˜ä¹¦",
                          f"å¯¼å…¥è´¦å·å…± {self.total_accounts} ä¸ªï¼Œèµ é€æˆåŠŸ {total_accounts} ä¸ªï¼Œæ˜¯å¦ç«‹å³è¿›å…¥ã€å°ç§˜ä¹¦ã€‘è¿›è¡Œå‘å¸ƒï¼Ÿ",
                          QMessageBox.Yes | QMessageBox.No, self)
        msg.setDefaultButton(QMessageBox.Yes)
        # æ”¹æŒ‰é’®æ–‡æœ¬
        msg.button(QMessageBox.Yes).setText("ç«‹å³å‘å¸ƒå°ç§˜ä¹¦")
        msg.button(QMessageBox.No).setText("æš‚ä¸å‘å¸ƒ")

        ret = msg.exec_()  # å¦‚æœæ˜¯ PyQt6ï¼Œç”¨ msg.exec()
        if ret == QMessageBox.Yes:
            try:
                self.mailTargetsReady.emit(targets)
            except Exception:
                pass
            try:
                if getattr(self, "nav", None):
                    self.nav.setCurrentRow(3)
            except Exception:
                pass

    def _prepare_mail_groups_early(self):
        """
        åœ¨å¼€å§‹æ´¾é€å‰ï¼ŒæŠŠæœ¬æ¬¡å¯¼å…¥ä¸­å‡ºç°è¿‡çš„å°ç»„å…ˆæ¨ç»™â€œå°ç§˜ä¹¦â€é¡µï¼Œ
        ä»…ç”¨äºæå‰ç”Ÿæˆæ–‡æœ¬æ¡†ï¼ˆAPPID å…ˆç•™ç©ºï¼‰ï¼Œä¾¿äºä½ æå‰ç²˜è´´å†…å®¹ã€‚
        ä»…åœ¨ send æ¨¡å¼ç”Ÿæ•ˆã€‚
        """
        if self.mode != "send":
            return

        groups = {}
        for row in range(self.table.rowCount()):
            group = (self.table.item(row, 0).text() or "").strip() if self.table.item(row, 0) else ""
            if group:
                groups.setdefault(group, [])  # å…ˆä¸ç»™ APPIDï¼Œåªç”Ÿæˆæ–‡æœ¬æ¡†

        if groups and hasattr(self, "mailTargetsReady"):
            # è§¦å‘å·²æœ‰ä¿¡å·ï¼šMailListPage.loadTargets ä¼šæ”¶åˆ°å¹¶ç”Ÿæˆæ¯ç»„æ–‡æœ¬æ¡†
            self.mailTargetsReady.emit(groups)

    # =========== å¯¼å…¥ ===========
    def import_file(self):
        """
        ä¸¥æ ¼æŒ‰é¡µé¢æ¨¡å¼æ ¡éªŒå¹¶å¯¼å…¥ Excelï¼š
        - èµ é€å½©é‡‘ï¼šå°ç»„ | APPID | èµ é€é‡‘é¢ | å½©é‡‘åç§°
        - æ‰£é™¤å½©é‡‘ï¼šå°ç»„ | APPID | æ‰£é™¤é‡‘é¢ | å½©é‡‘åç§°
        - æ‰£é™¤é’»çŸ³ï¼šå°ç»„ | APPID | æ‰£é™¤é’»çŸ³ | å¤‡æ³¨
        ä»…å…è®¸æ¨¡æ¿å››åˆ—ï¼ˆå¤šä¸€åˆ—ä¹Ÿä¼šæŠ¥é”™å¹¶ä¸­æ­¢ï¼‰ã€‚
        """
        path, _ = QFileDialog.getOpenFileName(self, "é€‰æ‹©Excel", "", "Excel Files (*.xlsx *.xls)")
        if not path:
            return

        # ä¸åŒæ¨¡å¼ä¸‹è¦æ±‚çš„åˆ—å
        if self.mode == "send":
            amount_col_name = "èµ é€é‡‘é¢"
            desc_col_name = "å½©é‡‘åç§°"
        elif self.mode == "deduct":
            amount_col_name = "æ‰£é™¤é‡‘é¢"
            desc_col_name = "å½©é‡‘åç§°"
        else:  # diamond
            amount_col_name = "æ‰£é™¤é’»çŸ³"
            desc_col_name = "å¤‡æ³¨"

        required_headers = ["å°ç»„", "APPID", amount_col_name, desc_col_name]

        try:
            wb = openpyxl.load_workbook(path)
            sheet = wb.active

            # è¯»å–è¡¨å¤´
            raw_headers = [cell.value for cell in sheet[1]]
            headers = [str(h).strip() if h is not None else "" for h in raw_headers]

            # === æ–°å¢ï¼šä»…å…è®¸æ¨¡æ¿å››åˆ—ï¼ˆéç©ºè¡¨å¤´å¿…é¡»æ°å¥½ 4 ä¸ªï¼Œä¸”é›†åˆå¿…é¡»ä¸ required_headers ç›¸åŒï¼‰===
            nonempty_headers = [h for h in headers if h]  # åªç»Ÿè®¡æœ‰åå­—çš„åˆ—
            if len(nonempty_headers) != 4:
                QMessageBox.critical(
                    self, "é”™è¯¯",
                    "æ¨¡æ¿å¿…é¡»ä»…åŒ…å« 4 åˆ—ï¼š{}\nå½“å‰æ£€æµ‹åˆ°çš„è¡¨å¤´ä¸ºï¼š{}".format(
                        "ã€".join(required_headers),
                        "ã€".join(nonempty_headers) if nonempty_headers else "ï¼ˆæ— ï¼‰"
                    )
                )
                return
            if set(nonempty_headers) != set(required_headers):
                QMessageBox.critical(
                    self, "é”™è¯¯",
                    "è¡¨å¤´ä¸åŒ¹é…ã€‚\nåº”ä¸ºï¼š{}\nå®é™…ï¼š{}".format(
                        "ã€".join(required_headers),
                        "ã€".join(nonempty_headers)
                    )
                )
                return
            # === æ ¡éªŒé€šè¿‡ï¼Œå®šä½åˆ—ï¼ˆä¸è¦æ±‚é¡ºåºä¸€è‡´ï¼‰===
            try:
                group_idx = headers.index("å°ç»„")
                appid_idx = headers.index("APPID")
                amount_idx = headers.index(amount_col_name)
                desc_idx = headers.index(desc_col_name)
            except ValueError:
                QMessageBox.critical(self, "é”™è¯¯", "æ— æ³•å®šä½æ¨¡æ¿åˆ—ï¼Œè¯·æ£€æŸ¥ç¬¬ä¸€è¡Œè¡¨å¤´æ˜¯å¦æ­£ç¡®ã€‚")
                return

            # åŒæ­¥è¡¨æ ¼åˆ—å¤´æ˜¾ç¤º
            self.table.setHorizontalHeaderLabels(['å°ç»„', 'APPID', amount_col_name, desc_col_name, 'çŠ¶æ€'])

            # æ¸…ç©ºå¹¶å¼€å§‹å¯¼å…¥
            self.table.setRowCount(0)
            total_amount = 0
            allowed_groups = load_group_names_from_config()

            for row_idx, row in enumerate(sheet.iter_rows(min_row=2, values_only=True), start=2):
                # å–å€¼ä¸æ¸…æ´—
                def _get(idx):
                    val = row[idx] if idx < len(row) else None
                    if isinstance(val, str):
                        return val.strip()
                    return val

                group_name = _get(group_idx) or ""
                appid_val = _get(appid_idx)
                amount_val = _get(amount_idx)
                desc_val = _get(desc_idx) or ""

                # åŸºç¡€æ ¡éªŒï¼ˆä¿æŒä½ åŸæ¥çš„é£æ ¼ï¼‰
                if not group_name:
                    QMessageBox.critical(self, "é”™è¯¯", f"ç¬¬ {row_idx} è¡Œçš„å°ç»„åç§°ä¸ºç©ºï¼Œè¯·æ£€æŸ¥")
                    return
                if not appid_val:
                    QMessageBox.critical(self, "é”™è¯¯", f"ç¬¬ {row_idx} è¡Œçš„ APPID ä¸ºç©ºï¼Œè¯·æ£€æŸ¥")
                    return
                # ä¿æŒåŸæœ‰â€œè½¬æ•´æ•°â€çš„å¤„ç†é€»è¾‘ï¼ˆå…è®¸ 1ã€1.0ã€1,000ï¼›1.1 ä¼šè¢«è½¬æˆ 1ï¼‰
                try:
                    amt_str = str(amount_val).replace(",", "").strip()
                    amt_int = int(float(amt_str))
                    if amt_int <= 0:
                        QMessageBox.critical(self, "é”™è¯¯", f"ç¬¬ {row_idx} è¡Œçš„é‡‘é¢/æ•°é‡å¿…é¡»å¤§äº 0ï¼Œè¯·æ£€æŸ¥")
                        return
                except Exception:
                    QMessageBox.critical(self, "é”™è¯¯", f"ç¬¬ {row_idx} è¡Œçš„é‡‘é¢/æ•°é‡æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥")
                    return
                if not desc_val:
                    QMessageBox.critical(self, "é”™è¯¯", f"ç¬¬ {row_idx} è¡Œçš„{desc_col_name}ä¸ºç©ºï¼Œè¯·æ£€æŸ¥")
                    return
                if group_name not in allowed_groups:
                    QMessageBox.critical(self, "é”™è¯¯",
                                         f"ç¬¬ {row_idx} è¡Œçš„å°ç»„ '{group_name}' æœªåœ¨ã€å‚æ•°é…ç½®ã€‘ä¸­å‡ºç°ï¼Œè¯·å…ˆå¡«å†™è¯¥ç»„ Cookie")
                    return

                appid_str = str(appid_val).strip()

                # å†™å…¥è¡¨æ ¼
                cur = self.table.rowCount()
                self.table.insertRow(cur)
                for col, val in enumerate([group_name, appid_str, str(amt_int), desc_val, 'å¾…å¤„ç†']):
                    item = QTableWidgetItem(str(val))
                    item.setFlags(item.flags() & ~Qt.ItemIsEditable)
                    self.table.setItem(cur, col, item)

                total_amount += amt_int

            # ç»Ÿè®¡ä¸è¿›åº¦
            self.total_accounts = self.table.rowCount()
            self.total_amount = int(total_amount)
            self.completed_count = 0
            self.stats_label.setText(f"{self.total_accounts} / {self.total_amount}ï¼ˆå·²å®Œæˆ{self.completed_count}ä¸ªï¼‰")
            self.progress_bar.setMaximum(self.total_accounts if self.total_accounts > 0 else 1)
            self.progress_bar.setValue(0)

            QMessageBox.information(self, "æˆåŠŸ", f"æˆåŠŸå¯¼å…¥ {self.total_accounts} ä¸ªè´¦å·")
            # >>> ç”Ÿæˆé‚®ä»¶æ–‡æœ¬æ¡†ï¼š
            self._prepare_mail_groups_early()

        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"å¯¼å…¥å¤±è´¥: {str(e)}")

    # =========== æ‰§è¡Œ ===========
    def perform_action(self):
        self.task_stopped = False
        password = (self.password_input.text() or "").strip()
        if password != '6666':
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·è¾“å…¥æ­£ç¡®çš„ç¡®è®¤å¯†ç ")
            return

        common, cookies = read_common_and_cookies()
        port = (common.get('port') or '').strip()
        login_code = (common.get('code') or '').strip()
        if not port or not login_code:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·å…ˆåˆ°ã€å‚æ•°é…ç½®ã€‘å¡«å†™å®Œæ•´å‚æ•°å¹¶ä¿å­˜")
            return

        # â‘  æœªå¯¼å…¥è´¦å·æ—¶çš„æç¤º
        if self.table.rowCount() == 0:
            QMessageBox.information(self, "æç¤º", "æœªå¯¼å…¥è´¦å·ï¼Œè¯·å…ˆå¯¼å…¥ Excelã€‚")
            return

        rows_data = []
        checked = self.no_code_checkbox.isChecked() if self.mode != "diamond" else False

        pending_total = 0  # è®°å½•â€œå¾…å¤„ç†â€çš„è¡Œæ•°
        missing_cookie_groups = set()  # è®°å½•å¾…å¤„ç†ä½†ç¼º Cookie çš„å°ç»„

        for row in range(self.table.rowCount()):
            item_status = self.table.item(row, 4)
            if not item_status or item_status.text() != 'å¾…å¤„ç†':
                continue

            pending_total += 1

            group_name = (self.table.item(row, 0).text() or "").strip()
            appid = (self.table.item(row, 1).text() or "").strip()
            amount_text = (self.table.item(row, 2).text() or "").strip()
            cjmc = (self.table.item(row, 3).text() or "").strip()

            try:
                amount_int = int(float(amount_text))
            except Exception:
                amount_int = 0

            token = (cookies.get(group_name, "") or "").strip()
            if not token:
                # è®°å½•è¯¥å°ç»„ç¼º Cookieï¼Œåé¢ç»Ÿä¸€æç¤º
                missing_cookie_groups.add(group_name)
                continue

            if self.mode == "send":
                liushui_value = '0' if checked else str(amount_int)
                url = f"http://v.boinht.com:{port}/pp_recharge/manual_recharge"
            elif self.mode == "deduct":
                liushui_value = f"-{amount_int}" if checked else '0'
                url = f"http://v.boinht.com:{port}/pp_recharge/manual_recharge"
            else:  # diamond
                liushui_value = '0'  # å ä½ï¼Œä¸ç”¨äºæ¥å£
                url = f"http://v.boinht.com:{port}/item/manual_send_item"

            headers = {'Cookie': f'token={token}'}
            rows_data.append((row, appid, amount_text, liushui_value, login_code, cjmc, headers, url, group_name))

        # â‘¡ å·²å¯¼å…¥ä½†â€œæ²¡æœ‰å¾…å¤„ç†â€çš„æç¤ºï¼ˆé¿å…é‡å¤æ´¾é€ï¼‰
        if pending_total == 0:
            QMessageBox.information(self, "æç¤º", "æ²¡æœ‰å¾…å¤„ç†çš„è´¦å·ï¼Œè¯·å‹¿é‡å¤æ´¾é€ã€‚")
            return

        # â‘¢ æœ‰å¾…å¤„ç†ä½†å› æœªé…ç½® Cookie å¯¼è‡´æ— æ³•æ‰§è¡Œçš„æç¤º
        if not rows_data:
            if missing_cookie_groups:
                groups = "ã€".join(sorted(g for g in missing_cookie_groups if g))
                msg = f"å­˜åœ¨å¾…å¤„ç†è´¦å·ï¼Œä½†ä»¥ä¸‹å°ç»„æœªé…ç½® Cookieï¼Œæ— æ³•æ‰§è¡Œï¼š{groups or 'ï¼ˆæœªå‘½åå°ç»„ï¼‰'}\nè¯·åˆ°ã€å‚æ•°é…ç½®ã€‘å¡«å†™å¹¶ä¿å­˜ Cookieã€‚"
            else:
                msg = "å­˜åœ¨å¾…å¤„ç†è´¦å·ï¼Œä½†ç¼ºå°‘å¿…è¦å‚æ•°ï¼Œæ— æ³•æ‰§è¡Œã€‚"
            QMessageBox.information(self, "æç¤º", msg)
            return

        # ç¦ç”¨äº¤äº’ & åˆå§‹åŒ–ç»Ÿè®¡ï¼ˆåŸæ ·ä¿ç•™ï¼‰
        self._set_enabled(False)
        self.task_finished_called = False
        self.completed_count = 0
        self.finished_workers = 0
        self.total_accounts = len(rows_data)
        self.total_amount = int(sum(self._safe_float(d[2]) for d in rows_data))
        self.stats_label.setText(f"{self.total_accounts} / {self.total_amount}ï¼ˆå·²å®Œæˆ0ä¸ªï¼‰")
        self.progress_bar.setMaximum(self.total_accounts)
        self.progress_bar.setValue(0)

        self.group_logs = []
        self.active_workers = []

        if self.mode == "send":
            # èµ é€ï¼šç»´æŒæŒ‰å°ç»„å¹¶å‘
            from collections import defaultdict  # é˜²æ­¢å¤–éƒ¨æœªå¯¼å…¥æ—¶ NameError
            grouped = defaultdict(list)
            for d in rows_data:
                grouped[d[-1]].append(d)
            for _, group_rows in grouped.items():
                worker = SendGiftWorker(group_rows, mode="send")
                worker.signals.result.connect(self.update_table_status)
                worker.signals.finished.connect(self.on_task_finished)
                self.active_workers.append(worker)
                self.threadpool.start(worker)
        elif self.mode == "deduct":
            # æ‰£é™¤å½©é‡‘ï¼šå• worker ä¸²è¡Œ + æ¯å•ç¡®è®¤
            worker = SendGiftWorker(rows_data, mode="deduct", confirm_each=True, confirm_timeout=15, poll_interval=1.0)
            worker.signals.result.connect(self.update_table_status)
            worker.signals.finished.connect(self.on_task_finished)
            self.active_workers.append(worker)
            self.threadpool.start(worker)
        else:
            # æ‰£é™¤é’»çŸ³ï¼šå• worker ä¸²è¡Œï¼Œä¸å¤æ ¸ã€ä¸é¢å¤–sleep
            worker = SendGiftWorker(rows_data, mode="diamond")
            worker.signals.result.connect(self.update_table_status)
            worker.signals.finished.connect(self.on_task_finished)
            self.active_workers.append(worker)
            self.threadpool.start(worker)

    def _safe_float(self, x):
        try:
            return float(x)
        except Exception:
            return 0.0

    def _set_enabled(self, enabled: bool):
        # åŸæ¥è¿™å‡ è¡Œä¿ç•™
        self.import_btn.setEnabled(enabled)
        self.action_btn.setEnabled(enabled)
        self.password_input.setEnabled(enabled)
        if self.mode != "diamond":
            self.no_code_checkbox.setEnabled(enabled)

        # æ–°å¢ï¼šé”/è§£é” å‚æ•°é…ç½®é¡µ
        if self.params_page is not None and hasattr(self.params_page, "set_enabled"):
            self.params_page.set_enabled(enabled)

        # å¯é€‰ï¼šé”/è§£é”å·¦ä¾§â€œå‚æ•°é…ç½®â€å¯¼èˆªé¡¹ï¼ˆç´¢å¼•æŒ‰ä½ çš„é¡ºåºæ¥ï¼‰
        if self.nav is not None and self.nav_params_index is not None:
            item = self.nav.item(self.nav_params_index)
            if item:
                flags = item.flags()
                if enabled:
                    item.setFlags(flags | Qt.ItemIsEnabled)
                else:
                    item.setFlags(flags & ~Qt.ItemIsEnabled)

    def _paint_status(self, item, text: str, final: bool = False):  # æ–°å¢ï¼šçŠ¶æ€ç€è‰²
        t = (text or "").strip()

        # 1) åŸºçº¿å­—ä½“ï¼šåªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œé¿å…é‡å¤ +1 å¯¼è‡´è¶Šåˆ·è¶Šå¤§
        base = getattr(self, "_status_base_font", None)
        if base is None:
            base = QFont("Microsoft YaHei")  # ç»Ÿä¸€å¾®è½¯é›…é»‘
            # ç”¨è¡¨æ ¼é»˜è®¤å­—å·ä½œä¸ºåŸºå‡†ï¼Œå†å›ºå®š +1
            ps = self.table.font().pointSize()
            if ps <= 0:
                ps = 12
            base.setPointSize(ps + 1)
            setattr(self, "_status_base_font", base)

        # æ¯æ¬¡éƒ½ä»åŸºçº¿æ‹·è´ï¼Œä¿è¯ä¸ç´¯åŠ 
        font = QFont(base)

        # 2) é¢œè‰² & åŠ ç²—
        if "æˆåŠŸ" in t:
            fg = QColor("#2ECC71")  # ç»¿
            font.setBold(True)
        elif "å¤æ ¸æœ‰è®°å½•" in t:
            fg = QColor("#F39C12").darker(110)  # æ·±æ©™
            font.setBold(True)
        elif t in ("å¾…å¤„ç†", ""):
            fg = QColor("#95A5A6")  # ç°
            font.setBold(False)
        else:
            fg = QColor("#E74C3C")  # çº¢
            font.setBold(True)

        # 3) åº”ç”¨
        item.setFont(font)
        item.setForeground(QBrush(fg))

    # =========== å­çº¿ç¨‹å›è°ƒ ===========
    def update_table_status(self, row_idx, status_text):
        if 0 <= row_idx < self.table.rowCount():
            status_col = getattr(self, "_status_col", 4)
            minw = getattr(self, "_status_min_width", 150)

            item = QTableWidgetItem(status_text)
            item.setFlags(item.flags() & ~Qt.ItemIsEditable)
            # NEW: ç€è‰²
            if hasattr(self, "_paint_status"):
                self._paint_status(item, status_text)

            self.table.setItem(row_idx, status_col, item)
            self.table.scrollToItem(item, QAbstractItemView.PositionAtBottom)

            self.completed_count += 1
            self.stats_label.setText(f"{self.total_accounts} / {self.total_amount}ï¼ˆå·²å®Œæˆ{self.completed_count}ä¸ªï¼‰")
            self.progress_bar.setValue(self.completed_count)

            # çŠ¶æ€åˆ—ï¼šæŒ‰å†…å®¹è‡ªé€‚åº”ï¼Œä½†ä¸å°‘äº minw
            self.table.resizeColumnToContents(status_col)
            if self.table.columnWidth(status_col) < minw:
                self.table.setColumnWidth(status_col, minw)

    def on_task_finished(self, logs):
        self.group_logs.extend(logs)
        self.finished_workers += 1

        if self.finished_workers != len(self.active_workers) or self.task_finished_called:
            return

        self.task_finished_called = True
        self.active_workers.clear()

        # æ¢å¤å…¶å®ƒæ§ä»¶ï¼›å¹¶ç¡®ä¿ Stop å§‹ç»ˆå¯ç‚¹
        self._set_enabled(True)
        self.stop_btn.setEnabled(True)  # <<< ç¡®ä¿åœæ­¢æŒ‰é’®å¯ç”¨

        action_name = "èµ é€å½©é‡‘" if self.mode == "send" else ("æ‰£é™¤å½©é‡‘" if self.mode == "deduct" else "æ‰£é™¤é’»çŸ³")

        # åœæ­¢åœºæ™¯
        if self.task_stopped:
            try:
                filename = save_log_to_excel(self.group_logs, mode=self.mode)
                QMessageBox.information(self, "å·²åœæ­¢", f"{action_name}å·²åœæ­¢ï¼Œæ—¥å¿—å·²ä¿å­˜ï¼š{filename}")
            except Exception as e:
                QMessageBox.warning(self, "è­¦å‘Š", str(e))
            self.reset_progress_ui()
            self.stats_label.setText("å·²åœæ­¢æ‰§è¡Œ")
            self.stop_btn.setEnabled(True)  # <<< åœæ­¢åä¾ç„¶ä¿æŒå¯ç‚¹
            return

        # æ­£å¸¸å®Œæˆï¼šsend/deduct è¿›å…¥å¤æ ¸ï¼›diamond ç›´æ¥ä¿å­˜
        if self.mode in ("send", "deduct"):
            failed_items = self._collect_failed_for_recheck()
            if failed_items:
                self.stats_label.setText(f"{action_name}å·²ç»“æŸï¼Œæ­£åœ¨å¤æ ¸å¤±è´¥è®°å½•â€¦è¯·ç¨ç­‰â€¦â€¦")
                self.stop_btn.setEnabled(True)  # <<< è¿›å…¥å¤æ ¸å‰ä¹Ÿä¿æŒå¯ç‚¹ï¼Œä¾¿äºéšæ—¶åœæ­¢å¤æ ¸
                self.recheck_failed_records(retries=3, delay_seconds=5.0)
                return

        self.progress_bar.setValue(self.completed_count)
        self.stats_label.setText(f"{action_name}å®Œæˆ")
        try:
            filename = save_log_to_excel(self.group_logs, mode=self.mode)
            QMessageBox.information(self, "å®Œæˆ", f"{action_name}å®Œæˆï¼Œæ—¥å¿—å·²ä¿å­˜ï¼š{filename}")
        except Exception as e:
            QMessageBox.warning(self, "è­¦å‘Š", str(e))
        finally:
            self.stop_btn.setEnabled(True)  # <<< æ­£å¸¸å®Œæˆåä¾ç„¶ä¿æŒå¯ç‚¹ï¼ˆå†—ä½™ä½†å®‰å…¨ï¼‰

        # NEW: èµ é€å½©é‡‘å®Œæˆåï¼Œè¯¢é—®æ˜¯å¦è¿›å…¥â€œå°ç§˜ä¹¦â€å¹¶æŠ›å‡º APPID æ¸…å•
        if self.mode == "send":
            self._maybe_prompt_send_mail()

    def reset_progress_ui(self):
        self.completed_count = 0
        self.total_accounts = 0
        self.total_amount = 0
        self.progress_bar.setMaximum(1)
        self.progress_bar.setValue(0)
        self.stats_label.setText("0 / 0ï¼ˆå·²å®Œæˆ0ä¸ªï¼‰")

    # ========= å¤æ ¸ç›¸å…³ =========
    def _collect_failed_for_recheck(self):
        """æ”¶é›†éœ€è¦å¤æ ¸çš„è¡Œï¼›é’»çŸ³æ¨¡å¼ç›´æ¥è¿”å›ç©ºã€‚"""
        if self.mode == "diamond":
            return []

        keywords = ("è¯·æ±‚å¤±è´¥", "æ¥å£æ— è¿”å›", "è¶…æ—¶", "è®¢å•è¶…æ—¶", "éªŒè¯è¢«æ‹’ç»", "å¤±è´¥")

        common, cookies = read_common_and_cookies()
        port = (common.get('port') or "").strip()
        code = (common.get('code') or "").strip()

        items = []
        for row in range(self.table.rowCount()):
            status_item = self.table.item(row, 4)
            status = (status_item.text() if status_item else "").strip()
            if not status:
                continue
            if any(k in status for k in keywords):
                group = (self.table.item(row, 0).text() or "").strip()
                appid = (self.table.item(row, 1).text() or "").strip()
                cjmc = (self.table.item(row, 3).text() or "").strip()

                token = (cookies.get(group, "") or "").strip()
                if not token:
                    # æ²¡æœ‰è¯¥ç»„ token æ— æ³•å¤æ ¸
                    continue

                headers = {"Cookie": f"token={token}"}
                items.append({
                    "row_idx": row,
                    "group": group,
                    "appid": appid,
                    "cjmc": cjmc,
                    "headers": headers,
                    "code": code,
                    "port": port,
                })
        return items

    def get_today_range_ts(self, to_now: bool = False):
        """
        æŒ‰åŒ—äº¬æ—¶é—´(Asia/Shanghai)è¿”å›æ—¶é—´èŒƒå›´çš„ epoch ç§’ã€‚
        - to_now=False: [ä»Šå¤©00:00, æ˜å¤©00:00)
        - to_now=True : [ä»Šå¤©00:00, ç°åœ¨)
        """
        sh = ZoneInfo("Asia/Shanghai")

        # å…ˆå– UTC å†è½¬åˆ°ç›®æ ‡æ—¶åŒºï¼Œé¿å…æœ¬æœºæ—¶åŒºå¹²æ‰°
        now = datetime.now(timezone.utc).astimezone(sh)

        # åŒ—äº¬æ—¶é—´çš„ä»Šå¤©é›¶ç‚¹
        start_dt = datetime(now.year, now.month, now.day, tzinfo=sh)
        end_dt = now if to_now else (start_dt + timedelta(days=1))

        print("now:", now, "| start:", start_dt, "| end:", end_dt)
        return int(start_dt.timestamp()), int(end_dt.timestamp())

    def set_table_status_no_progress(self, row_idx: int, status_text: str):
        """ä»…å†™çŠ¶æ€åˆ—ï¼ˆå¤æ ¸ç»“æœå›å†™ï¼‰ï¼Œä¸æ”¹å˜è¿›åº¦/è®¡æ•°ã€‚"""
        if 0 <= row_idx < self.table.rowCount():
            status_col = getattr(self, "_status_col", 4)
            minw = getattr(self, "_status_min_width", 150)

            item = self.table.item(row_idx, status_col)
            if item is None:
                item = QTableWidgetItem()
                item.setFlags(item.flags() & ~Qt.ItemIsEditable)
                self.table.setItem(row_idx, status_col, item)

            item.setText(status_text)
            # NEW: ç€è‰²
            if hasattr(self, "_paint_status"):
                self._paint_status(item, status_text)

            self.table.scrollToItem(item, QAbstractItemView.PositionAtBottom)

            # åŒæ­¥è°ƒæ•´çŠ¶æ€åˆ—å®½åº¦
            self.table.resizeColumnToContents(status_col)
            if self.table.columnWidth(status_col) < minw:
                self.table.setColumnWidth(status_col, minw)

    def recheck_failed_records(self, retries: int = 3, delay_seconds: float = 5.0):
        if self.mode == "diamond":
            return  # é’»çŸ³ä¸å¤æ ¸

        items = self._collect_failed_for_recheck()
        if not items:
            QMessageBox.information(self, "å¤æ ¸", "æ²¡æœ‰éœ€è¦å¤æ ¸çš„å¤±è´¥è®°å½•ã€‚")
            return

        begin_ts, end_ts = self.get_today_range_ts()

        self.in_recheck = True
        self.recheck_worker = RecheckPaymentWorker(
            items=items,
            begin_ts=begin_ts,
            end_ts=end_ts,
            retries=retries,
            delay_seconds=delay_seconds
        )
        # å¤æ ¸ç»“æœåªå†™çŠ¶æ€åˆ—ï¼Œä¸å½±å“è¿›åº¦ç»Ÿè®¡
        self.recheck_worker.signals.result.connect(self.set_table_status_no_progress)
        self.recheck_worker.signals.finished.connect(self._on_recheck_finished)
        self.threadpool.start(self.recheck_worker)

    def _on_recheck_finished(self, logs: list):
        # æ ‡è®°é€€å‡ºå¤æ ¸é˜¶æ®µï¼Œå¹¶æ¸…ç†å¼•ç”¨
        self.in_recheck = False
        self.recheck_worker = None

        # åˆå¹¶å¤æ ¸æ—¥å¿—
        if hasattr(self, "group_logs"):
            self.group_logs.extend(logs)

        self.progress_bar.setValue(self.completed_count)

        # è‹¥åœ¨å¤æ ¸ä¸­è¢«ç”¨æˆ·åœæ­¢
        if getattr(self, "task_stopped", False):
            try:
                filename = save_log_to_excel(self.group_logs, mode=self.mode)
                QMessageBox.information(self, "å·²åœæ­¢", f"å¤æ ¸å·²åœæ­¢ï¼Œæ—¥å¿—å·²ä¿å­˜ï¼š{filename}")
            except Exception as e:
                QMessageBox.warning(self, "è­¦å‘Š", str(e))
            self.reset_progress_ui()
            self.stats_label.setText("å·²åœæ­¢æ‰§è¡Œ")
            self._set_enabled(True)
            self.stop_btn.setEnabled(True)  # <<< åœæ­¢å¤æ ¸åï¼Œç¡®ä¿åœæ­¢æŒ‰é’®å¯ç”¨
            return

        # æ­£å¸¸å®Œæˆ
        action_name = "èµ é€å½©é‡‘" if self.mode == "send" else "æ‰£é™¤å½©é‡‘"
        self.stats_label.setText(f"{action_name}å·²å®Œæˆï¼ˆå¤æ ¸å®Œæˆï¼‰")
        try:
            filename = save_log_to_excel(self.group_logs, mode=self.mode)
            QMessageBox.information(self, "å®Œæˆ", f"å¤æ ¸å®Œæˆï¼Œæ—¥å¿—å·²ä¿å­˜ï¼š{filename}")
        except Exception as e:
            QMessageBox.warning(self, "è­¦å‘Š", str(e))
        finally:
            # å¤æ ¸ç»“æŸåï¼Œæ¢å¤å…¶å®ƒæ§ä»¶å¹¶ä¿è¯ Stop å¯ç‚¹
            self._set_enabled(True)
            self.stop_btn.setEnabled(True)  # <<< å¤æ ¸å®Œæˆåï¼Œç¡®ä¿åœæ­¢æŒ‰é’®å¯ç”¨

        # NEW: å¤æ ¸å®Œæˆåï¼ˆèµ é€å½©é‡‘ï¼‰ï¼Œè¯¢é—®æ˜¯å¦è¿›å…¥â€œå°ç§˜ä¹¦â€å¹¶æŠ›å‡º APPID æ¸…å•
        if self.mode == "send":
            self._maybe_prompt_send_mail()


############################################
# 5) å…³äºæˆ‘ä»¬é¡µ
############################################

class AboutPage(QWidget):
    def __init__(self, parent=None, product_name="å½©é‡‘èµ é€å·¥å…·",
                 version="v1.2.1", build_date="2025-10-11"):
        super().__init__(parent)

        root = QVBoxLayout(self)
        root.setContentsMargins(24, 20, 24, 20)
        root.setSpacing(14)

        # åŸºç¡€å­—ä½“ï¼ˆæ­£æ–‡ï¼‰
        base = QFont("Microsoft YaHei UI")
        base.setPointSize(11)
        self.setFont(base)

        # æ ‡é¢˜
        title = QLabel(f"å…³äº{product_name}")
        title_font = QFont(base)
        title_font.setPointSize(18)
        title_font.setWeight(QFont.DemiBold)
        title.setFont(title_font)
        title.setStyleSheet("color:#0f172a;")
        root.addWidget(title, 0, Qt.AlignLeft)

        # â€”â€”ç‰ˆæœ¬è¡Œï¼šä¸‰ä¸ªæ§ä»¶åŒä¸€å­—ä½“å¤§å°ï¼ˆæ›´é†’ç›®ï¼‰â€”â€”
        meta_font = QFont(base)
        meta_font.setPointSize(12)  # æ¯”æ­£æ–‡ç•¥å¤§ï¼›ä¸‰è€…ç»Ÿä¸€
        # meta_font.setWeight(QFont.Medium)        # å¦‚éœ€å†é†’ç›®ï¼Œå¯æ‰“å¼€æ­¤è¡Œç•¥åŠ ç²—

        ver_row = QHBoxLayout()
        ver_row.setSpacing(12)

        ver_label = QLabel("ç‰ˆæœ¬ï¼š")
        ver_label.setFont(meta_font)

        ver_value = QLabel(version)
        ver_value.setFont(meta_font)
        ver_value.setStyleSheet("color:#0f766e;")  # ç»¿è‰²ä½†ä¸â€œç‰ˆæœ¬ï¼šâ€åŒå­—å·

        date_label = QLabel(f"  æ›´æ–°æ—¥æœŸï¼š{build_date}")
        date_label.setFont(meta_font)
        date_label.setStyleSheet("color:#64748b;")  # slate-500ï¼Œä½†åŒå­—å·

        ver_row.addWidget(ver_label, 0, Qt.AlignLeft)
        ver_row.addWidget(ver_value, 0, Qt.AlignLeft)
        ver_row.addWidget(date_label, 0, Qt.AlignLeft)
        ver_row.addStretch(1)
        root.addLayout(ver_row)

        spacer = QFrame()
        spacer.setFixedHeight(6)
        spacer.setFrameShape(QFrame.NoFrame)
        root.addWidget(spacer)

        # å£°æ˜æ ‡é¢˜
        decl_title = QLabel("å£°æ˜ï¼š")
        decl_font = QFont(base)
        decl_font.setPointSize(13)
        decl_font.setWeight(QFont.DemiBold)
        decl_title.setFont(decl_font)
        decl_title.setStyleSheet("color:#111827;")
        root.addWidget(decl_title, 0, Qt.AlignLeft)

        # å£°æ˜æ­£æ–‡ï¼ˆQTextBrowser é˜²è£è¡Œï¼‰
        html = """
        <div style="max-width: 960px;">
          <p style="line-height:1.9; color:#334155;">
            æœ¬è½¯ä»¶ä»…ä¾›å…·å¤‡å‘æ”¾å’Œæ‰£é™¤æƒé™ä¸”å·²è·æˆæƒçš„è´¦æˆ·ï¼Œåœ¨åˆè§„å‰æä¸‹ç”¨äºèµ é€å½©é‡‘/æ‰£é™¤å½©é‡‘/æ‰£é™¤é’»çŸ³/å‘å¸ƒå°ç§˜ä¹¦ã€‚
            ä½¿ç”¨è€…åº”ç¡®ä¿æ•°æ®ä¸è´¦å·æ¥æºåˆè§„ã€æˆæƒå……åˆ†ï¼Œå¹¶å¯¹è‡ªèº«æ“ä½œåŠç»“æœæ‰¿æ‹…å…¨éƒ¨è´£ä»»ã€‚
          </p>
          <p style="line-height:1.9; color:#334155;">
            å› æˆæƒä¸è¶³æˆ–è¿è§„ä½¿ç”¨å¯¼è‡´çš„ä»»ä½•æŸå¤±ã€å‡ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚
            æœ¬è½¯ä»¶æŒ‰â€œç°çŠ¶â€æä¾›ï¼Œä¸ä½œä»»ä½•æ˜ç¤ºæˆ–é»˜ç¤ºæ‹…ä¿ï¼›ä½œè€…å¯¹å› ä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨æœ¬è½¯ä»¶é€ æˆçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±ä¸æ‰¿æ‹…è´£ä»»ã€‚
            æœ¬è½¯ä»¶ä¸ç›¸å…³å¹³å°/å•†æˆ·/æ”¯ä»˜æœºæ„æ— éš¶å±æˆ–åˆä½œå…³ç³»ã€‚
          </p>
          <p style="line-height:1.9; color:#334155;"><b>ç»§ç»­ä½¿ç”¨å³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„æœ¬å£°æ˜ã€‚</b></p>
        </div>
        """
        browser = QTextBrowser()
        browser.setHtml(html)
        browser.setFrameShape(QFrame.NoFrame)
        browser.setOpenExternalLinks(True)
        browser.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        browser.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)

        root.addWidget(browser, 1)


class MailListPage(QWidget):
    """
    å°ç§˜ä¹¦ï¼š
    - æ¯ä¸ªå°ç»„ä¸€ä¸ªæ–‡æœ¬æ¡†ï¼Œç”¨æˆ·è‡ªè¡Œç²˜è´´å†…å®¹
    - åªæ¥æ”¶ GiftPage.emit() è¿‡æ¥çš„ APPID æ¸…å•
    - ç»„ä¸ç»„å¹¶å‘ï¼›ç»„å†…æŒ‰ <=1000 æ‰¹é‡å‘é€
    - æ–°å¢ï¼šæ¨¡æ¿åŒ…ï¼ˆä¸‹æ‹‰+å››ä¸ªæŒ‰é’®ï¼‰
    """

    def __init__(self, parent=None, params_page: QWidget = None, nav=None, nav_params_index: int = 4):
        super().__init__(parent)
        self.params_page = params_page
        self.nav = nav
        self.nav_params_index = nav_params_index

        self.threadpool = QThreadPool()
        self.active_workers = []
        self.mail_logs = []
        self.targets_map = {}   # {"ç»„å":[appid,...]}
        self.content_edits = {} # {"ç»„å": QTextEdit}
        self.status_labels = {} # {"ç»„å": QLabel}
        self.cached_contents = {}
        self.first_loaded = False

        # é¡¶éƒ¨ç»Ÿè®¡
        self.total_label = QLabel("å°ç»„ï¼š0 / è´¦å·ï¼š0")
        self.progress = QProgressBar()
        self.progress.setAlignment(Qt.AlignCenter)

        # ==== æ¨¡æ¿åŒ…å·¥å…·æ¡ ====
        tpl_row = QHBoxLayout()
        tpl_row.setSpacing(8)

        self.tpl_combo = QComboBox()
        self.tpl_combo.setMinimumWidth(220)
        self.tpl_combo.addItem("ï¼ˆæœªé€‰æ‹©æ¨¡æ¿ï¼‰", userData=None)

        self.chk_only_empty = QCheckBox("ä»…å¡«ç©ºç™½")
        self.chk_only_empty.setChecked(True)

        self.btn_tpl_reload = QPushButton("é‡æ–°åŠ è½½")
        self.btn_tpl_apply  = QPushButton("åº”ç”¨æ¨¡æ¿")
        self.btn_tpl_save   = QPushButton("ä¿å­˜ä¸ºæ¨¡æ¿åŒ…")
        self.btn_clear_text = QPushButton("æ¸…ç©ºæ–‡æœ¬æ¡†")

        for b in (self.btn_tpl_reload, self.btn_tpl_apply, self.btn_tpl_save, self.btn_clear_text):
            b.setMinimumHeight(28)

        tpl_row.addWidget(QLabel("æ¨¡æ¿åŒ…ï¼š"))
        tpl_row.addWidget(self.tpl_combo)
        tpl_row.addWidget(self.chk_only_empty)
        tpl_row.addStretch(1)
        tpl_row.addWidget(self.btn_tpl_reload)
        tpl_row.addWidget(self.btn_tpl_apply)
        tpl_row.addWidget(self.btn_tpl_save)
        tpl_row.addWidget(self.btn_clear_text)

        # æ»šåŠ¨åŒºå®¹å™¨
        self.container = QWidget()
        self.container_layout = QVBoxLayout(self.container)
        self.container_layout.setContentsMargins(8, 8, 8, 8)
        self.container_layout.setSpacing(10)
        self.container_layout.addStretch(1)

        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setWidget(self.container)

        # æŒ‰é’®åŒº
        self.send_btn = QPushButton("ğŸ¤– å¼€å§‹å‘å¸ƒ")
        self.stop_btn = QPushButton("ğŸ›‘ åœæ­¢")
        self.send_btn.setMinimumHeight(36)
        self.stop_btn.setMinimumHeight(36)
        self.send_btn.setEnabled(False)

        self.send_btn.clicked.connect(self.start_send)
        self.stop_btn.clicked.connect(self.stop_send)

        # æ¨¡æ¿æŒ‰é’®æ§½
        self.btn_tpl_reload.clicked.connect(self._refresh_template_list)
        self.btn_tpl_apply.clicked.connect(self._apply_selected_template)
        self.btn_tpl_save.clicked.connect(self._save_as_template)
        self.btn_clear_text.clicked.connect(self._clear_all_group_texts)

        btn_row = QHBoxLayout()
        btn_row.addStretch(1)
        btn_row.addWidget(self.send_btn)
        btn_row.addWidget(self.stop_btn)

        # ä¸»å¸ƒå±€
        root = QVBoxLayout(self)
        root.addWidget(self.total_label)
        root.addLayout(tpl_row)       # æŠŠæ¨¡æ¿å·¥å…·æ¡æ”¾åœ¨ç»Ÿè®¡æ ä¸‹æ–¹
        root.addWidget(scroll, 1)
        root.addLayout(btn_row)
        root.addWidget(self.progress)

        # è¿è¡Œæ—¶ç»Ÿè®¡
        self.total_accounts = 0
        self.sent_accounts = 0
        self.finished_workers = 0

        # åˆå§‹åŒ–æ¨¡æ¿åˆ—è¡¨
        self._refresh_template_list()

    # ---------- æ¨¡æ¿åŒ…ï¼šå†…éƒ¨å·¥å…· ----------

    def _template_dir(self) -> str:
        import os, sys
        # å…¼å®¹ PyInstaller æ‰“åŒ…åçš„å¯æ‰§è¡Œç›®å½•
        base = os.path.dirname(os.path.abspath(sys.argv[0]))
        path = os.path.join(base, "templates")  # åªç”¨ templates ç›®å½•
        return path

    def _ensure_template_dir(self) -> str:
        import os
        path = self._template_dir()
        os.makedirs(path, exist_ok=True)
        return path

    def _scan_templates(self):
        import os, json
        dirpath = self._ensure_template_dir()
        items = []
        try:
            files = [f for f in os.listdir(dirpath) if f.lower().endswith(".json")]
            files.sort(key=lambda x: x.lower())
            for f in files:
                fp = os.path.join(dirpath, f)
                file_base = os.path.splitext(f)[0]
                display = file_base
                json_name = None
                try:
                    with open(fp, "r", encoding="utf-8") as r:
                        data = json.load(r)
                        if isinstance(data, dict):
                            json_name = (data.get("name") or "").strip()
                            if json_name:
                                # åªæœ‰å½“ name ä¸ æ–‡ä»¶å ä¸åŒæ—¶æ‰æ˜¾ç¤ºâ€œï¼ˆæ–‡ä»¶åï¼‰â€
                                if json_name.lower() != file_base.lower():
                                    display = f"{json_name}ï¼ˆ{file_base}ï¼‰"
                                else:
                                    display = json_name
                except Exception:
                    pass
                items.append((display, fp, json_name))
        except Exception:
            pass
        return items

    def _refresh_template_list(self):
        """é‡æ–°åŠ è½½æ¨¡æ¿ä¸‹æ‹‰æ¡†"""
        self.tpl_combo.blockSignals(True)
        try:
            self.tpl_combo.clear()
            self.tpl_combo.addItem("ï¼ˆæœªé€‰æ‹©æ¨¡æ¿ï¼‰", userData=None)
            self._tpl_items = self._scan_templates()  # ç¼“å­˜
            for display, fp, _jn in self._tpl_items:
                self.tpl_combo.addItem(display, userData=fp)
            # é»˜è®¤ä¸é€‰ä»»ä½•æ¨¡æ¿
            self.tpl_combo.setCurrentIndex(0)
        finally:
            self.tpl_combo.blockSignals(False)

    def _apply_selected_template(self):
        """è¯»å–é€‰ä¸­æ¨¡æ¿ï¼ŒæŠŠ groups æ–‡æ¡ˆå¡«å……åˆ°å¯¹åº”çš„å°ç»„æ–‡æœ¬æ¡†"""
        from PyQt5.QtWidgets import QMessageBox
        import json, os

        fp = self.tpl_combo.currentData()
        if not fp:
            QMessageBox.information(self, "æç¤º", "è¯·å…ˆåœ¨â€œæ¨¡æ¿åŒ…â€ä¸‹æ‹‰ä¸­é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿ã€‚")
            return
        if not os.path.exists(fp):
            QMessageBox.warning(self, "æç¤º", "æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå·²ä¸ºä½ åˆ·æ–°åˆ—è¡¨ã€‚")
            self._refresh_template_list()
            return

        try:
            with open(fp, "r", encoding="utf-8") as r:
                data = json.load(r)
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"æ¨¡æ¿è§£æå¤±è´¥ï¼š{e}")
            return

        groups = {}
        if isinstance(data, dict):
            # å…¼å®¹ä½ ç»™çš„ç»“æ„ï¼š{"name": "...", "groups": {...}}
            groups = data.get("groups") or {}
        if not isinstance(groups, dict) or not groups:
            QMessageBox.information(self, "æç¤º", "è¯¥æ¨¡æ¿æ²¡æœ‰å¯ç”¨çš„ç»„å†…å®¹ã€‚")
            return

        only_empty = self.chk_only_empty.isChecked()
        filled, skipped, missing = 0, 0, 0

        # ä»¥å½“å‰é¡µé¢å­˜åœ¨çš„å°ç»„ä¸ºå‡†
        for g, edit in self.content_edits.items():
            if g in groups:
                txt = str(groups.get(g) or "")
                if not txt.strip():
                    skipped += 1
                    continue
                if only_empty and edit.toPlainText().strip():
                    skipped += 1
                else:
                    edit.setPlainText(txt)
                    filled += 1
            else:
                missing += 1

        msg = f"å¡«å……å®Œæˆï¼šæˆåŠŸ {filled} ç»„"
        if skipped:
            msg += f"ï¼Œè·³è¿‡ {skipped} ç»„"
        if missing:
            msg += f"ï¼Œæ¨¡æ¿ä¸­ç¼ºå°‘ {missing} ä¸ªå½“å‰é¡µé¢çš„å°ç»„"
        QMessageBox.information(self, "åº”ç”¨æ¨¡æ¿", msg)

    def _save_as_template(self):
        """æŠŠå½“å‰é¡µé¢æ‰€æœ‰éç©ºæ–‡æœ¬æ¡†ä¿å­˜ä¸ºä¸€ä¸ªæ¨¡æ¿åŒ…ï¼ˆJSONï¼‰ï¼Œè¾“å…¥æ¡†æŒ‰é’®ä¸ºä¸­æ–‡ï¼šç¡®å®š/å–æ¶ˆ"""
        from PyQt5.QtWidgets import QInputDialog, QDialog, QDialogButtonBox, QMessageBox
        import json, os, re

        # æ”¶é›†éç©ºå†…å®¹
        groups_content = {}
        for g, edit in self.content_edits.items():
            txt = edit.toPlainText()
            if txt.strip():
                groups_content[g] = txt

        if not groups_content:
            QMessageBox.information(self, "æç¤º", "æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹ï¼ˆå½“å‰æ‰€æœ‰æ–‡æœ¬æ¡†å‡ä¸ºç©ºï¼‰ã€‚")
            return

        # --- ä¸­æ–‡æŒ‰é’®çš„è¾“å…¥å¼¹çª— ---
        dlg = QInputDialog(self)
        dlg.setWindowTitle("ä¿å­˜ä¸ºæ¨¡æ¿åŒ…")
        dlg.setLabelText("è¯·è¾“å…¥æ¨¡æ¿åï¼š")
        dlg.setTextValue("")  # ä½ ä¹Ÿå¯ä»¥è®¾ç½®é»˜è®¤å€¼
        dlg.setComboBoxEditable(False)

        # ä¼˜å…ˆä½¿ç”¨å®˜æ–¹ APIï¼ˆéƒ¨åˆ† PyQt ç‰ˆæœ¬æ”¯æŒï¼‰
        try:
            dlg.setOkButtonText("ç¡®å®š")
            dlg.setCancelButtonText("å–æ¶ˆ")
        except Exception:
            # å…¼å®¹æ—§ç‰ˆæœ¬ï¼šç›´æ¥æ”¹ ButtonBox æ–‡æ¡ˆ
            box = dlg.findChild(QDialogButtonBox)
            if box:
                btn_ok = box.button(QDialogButtonBox.Ok)
                btn_cancel = box.button(QDialogButtonBox.Cancel)
                if btn_ok:
                    btn_ok.setText("ç¡®å®š")
                if btn_cancel:
                    btn_cancel.setText("å–æ¶ˆ")

        if dlg.exec_() != QDialog.Accepted:
            return  # ç”¨æˆ·ç‚¹äº†â€œå–æ¶ˆâ€
        name = (dlg.textValue() or "").strip()

        if not name:
            QMessageBox.information(self, "æç¤º", "æ¨¡æ¿åä¸èƒ½ä¸ºç©ºã€‚")
            return

        # ç”Ÿæˆæ–‡ä»¶åï¼ˆæ¸…ç†éæ³•å­—ç¬¦ï¼‰
        safe_name = re.sub(r'[\\/:*?"<>|]+', "_", name).strip()
        if not safe_name:
            QMessageBox.information(self, "æç¤º", "æ¨¡æ¿åæ— æ•ˆã€‚")
            return

        dirpath = self._ensure_template_dir()
        filepath = os.path.join(dirpath, f"{safe_name}.json")

        # å¦‚æœå­˜åœ¨ï¼Œç¡®è®¤æ˜¯å¦è¦†ç›–ï¼ˆä¸­æ–‡æŒ‰é’®è‡ªåŠ¨è·Ÿéšç³»ç»Ÿ/Qt ç¿»è¯‘ï¼‰
        if os.path.exists(filepath):
            ret = QMessageBox.question(
                self, "è¦†ç›–ç¡®è®¤", f"æ¨¡æ¿â€œ{safe_name}â€å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ",
                QMessageBox.Yes | QMessageBox.No, QMessageBox.No
            )
            if ret != QMessageBox.Yes:
                return

        data = {"name": name, "groups": groups_content}

        try:
            with open(filepath, "w", encoding="utf-8") as w:
                json.dump(data, w, ensure_ascii=False, indent=2)
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"ä¿å­˜å¤±è´¥ï¼š{e}")
            return

        # åˆ·æ–°ä¸‹æ‹‰å¹¶è‡ªåŠ¨é€‰ä¸­åˆšä¿å­˜çš„æ¨¡æ¿
        self._refresh_template_list()
        for i in range(self.tpl_combo.count()):
            if self.tpl_combo.itemData(i) == filepath:
                self.tpl_combo.setCurrentIndex(i)
                break

        QMessageBox.information(self, "æˆåŠŸ", f"å·²ä¿å­˜æ¨¡æ¿ï¼š{filepath}")

    # ---------- ä½ åŸæœ‰é€»è¾‘ï¼ˆæœªæ”¹åŠ¨æ ¸å¿ƒæµç¨‹ï¼‰ ----------

    def _reset_after_finish(self):
        """å‘é€å®Œæˆåé‡ç½®ç»Ÿè®¡ä¸è¿›åº¦æ¡åˆ° 0ï¼Œå¹¶æ¸…ç©ºç›®æ ‡ï¼Œç¦ç”¨å‘é€æŒ‰é’®ã€‚"""
        self.total_accounts = 0
        self.sent_accounts = 0
        self.finished_workers = 0
        self.progress.setMaximum(1)
        self.progress.setValue(0)
        self.total_label.setText("å°ç»„ï¼š0 / è´¦å·ï¼š0")
        self.targets_map.clear()
        self.send_btn.setEnabled(False)

    def _set_enabled(self, enabled: bool):
        self.send_btn.setEnabled(enabled)
        self.stop_btn.setEnabled(enabled)

        # æ¨¡æ¿å·¥å…·æ¡åœ¨å‘é€è¿‡ç¨‹ä¸­ä¹Ÿå¯ä»¥ç”¨ï¼ˆæŒ‰éœ€ä½ å¯æ”¹ä¸ºç¦ç”¨ï¼‰
        self.tpl_combo.setEnabled(enabled)
        self.chk_only_empty.setEnabled(enabled)
        self.btn_tpl_reload.setEnabled(enabled)
        self.btn_tpl_apply.setEnabled(enabled)
        self.btn_tpl_save.setEnabled(enabled)
        self.btn_clear_text.setEnabled(enabled)

        for edit in self.content_edits.values():
            edit.setEnabled(enabled)

        if self.params_page is not None and hasattr(self.params_page, "set_enabled"):
            self.params_page.set_enabled(enabled)

        if self.nav is not None and self.nav_params_index is not None:
            item = self.nav.item(self.nav_params_index)
            if item:
                flags = item.flags()
                if enabled:
                    item.setFlags(flags | Qt.ItemIsEnabled)
                else:
                    item.setFlags(flags & ~Qt.ItemIsEnabled)

    def _make_group_box(self, group: str, count: int):
        box = QGroupBox(f"{group}ï¼ˆ{count} ä¸ªï¼‰")
        v = QVBoxLayout(box)
        edit = QTextEdit()
        edit.setPlaceholderText("åœ¨æ­¤ç²˜è´´è¯¥å°ç»„è¦å‘å¸ƒçš„å°ç§˜ä¹¦å†…å®¹â€¦")
        edit.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
        edit.setMinimumHeight(140)
        edit.setTabChangesFocus(True)

        status = QLabel("çŠ¶æ€ï¼šå¾…å‘é€")
        v.addWidget(edit)
        v.addWidget(status)

        self.content_edits[group] = edit
        self.status_labels[group] = status
        return box

    # === å¯¹æ¥ GiftPage ===
    def loadTargets(self, target_map: dict):
        target_map = target_map or {}

        # 1) å¿«ç…§å½“å‰å·²ç²˜è´´çš„å†…å®¹ï¼Œç¨åæ¢å¤
        snap = {g: e.toPlainText() for g, e in self.content_edits.items()}
        for g, txt in snap.items():
            if txt:
                self.cached_contents[g] = txt

        # 2) è¯»å– Cookie é¡ºåºï¼›å–ä¸åˆ°å°±é€€åŒ–ä¸ºç©ºåˆ—è¡¨
        try:
            _common, cookies = read_common_and_cookies()
            cookie_order = [k for k in cookies.keys() if k]
        except Exception:
            cookie_order = []

        # 3) è®¡ç®—å¹¶æ’åº
        incoming_groups = [g for g in (target_map.keys() if target_map else []) if g]
        seen = set()
        incoming_groups = [g for g in incoming_groups if not (g in seen or seen.add(g))]
        ordered_groups = [g for g in cookie_order if g in incoming_groups] + \
                         [g for g in incoming_groups if g not in cookie_order]

        # 4) æ¸…ç©ºé‡å»º
        while self.container_layout.count():
            item = self.container_layout.takeAt(0)
            w = item.widget()
            if w:
                w.deleteLater()
        self.content_edits.clear()
        self.status_labels.clear()

        total_accounts = sum(len(target_map.get(g, [])) for g in ordered_groups)

        for g in ordered_groups:
            count = len(target_map.get(g, []))
            box = self._make_group_box(g, count)
            self.container_layout.addWidget(box)
            if g in self.cached_contents and not self.content_edits[g].toPlainText():
                self.content_edits[g].setPlainText(self.cached_contents[g])

        self.container_layout.addStretch(1)

        self.targets_map = {
            g: [str(x).strip() for x in (target_map.get(g) or []) if str(x).strip()]
            for g in ordered_groups
        }

        self.total_accounts = total_accounts
        self.sent_accounts = 0
        self.finished_workers = 0
        self.progress.setMaximum(max(1, total_accounts))
        self.progress.setValue(0)
        self.total_label.setText(f"å°ç»„ï¼š{len(ordered_groups)} / è´¦å·ï¼š{total_accounts}")
        self.send_btn.setEnabled(total_accounts > 0)

        if not getattr(self, "first_loaded", False):
            self.first_loaded = True
            # å¯é€‰æç¤º
            # QMessageBox.information(self, "å°ç§˜ä¹¦", "å·²ç”Ÿæˆå„å°ç»„æ–‡æœ¬æ¡†ï¼Œå¯æå‰ç²˜è´´é‚®ä»¶å†…å®¹ã€‚")

    def start_send(self):
        from PyQt5.QtWidgets import QInputDialog, QDialog, QDialogButtonBox, QMessageBox

        if not self.targets_map:
            QMessageBox.information(self, "æç¤º", "æ²¡æœ‰å¯å‘é€çš„è´¦å·ã€‚")
            return

        has_content = any((edit.toPlainText().strip() for edit in self.content_edits.values()))
        if not has_content:
            QMessageBox.information(self, "æç¤º", "è¯·å…ˆåœ¨è‡³å°‘ä¸€ä¸ªå°ç»„æ–‡æœ¬æ¡†ç²˜è´´å°ç§˜ä¹¦å†…å®¹ã€‚")
            return

        # é€‰æ‹©è¿‡æœŸå¤©æ•°
        dlg = QInputDialog(self)
        dlg.setWindowTitle("é€‰æ‹©è¿‡æœŸæ—¶é—´")
        dlg.setLabelText("è¿‡æœŸæ—¶é—´ï¼ˆå¤©ï¼‰ï¼š")
        items = ["1", "3", "7", "15", "30", "90"]
        dlg.setComboBoxItems(items)
        dlg.setComboBoxEditable(False)
        dlg.setTextValue("7")
        try:
            dlg.setOkButtonText("ç¡®å®š")
            dlg.setCancelButtonText("å–æ¶ˆ")
        except Exception:
            box = dlg.findChild(QDialogButtonBox)
            if box:
                btn_ok = box.button(QDialogButtonBox.Ok)
                btn_cancel = box.button(QDialogButtonBox.Cancel)
                if btn_ok: btn_ok.setText("ç¡®å®š")
                if btn_cancel: btn_cancel.setText("å–æ¶ˆ")

        if dlg.exec_() != QDialog.Accepted:
            return
        chosen = dlg.textValue().strip()
        expire_days = int(chosen) if chosen in items else 7

        # å…¬å…±å‚æ•°
        common, cookies = read_common_and_cookies()
        port = (common.get('port') or '').strip()
        code = (common.get('code') or '').strip()
        if not port or not code:
            QMessageBox.warning(self, "è­¦å‘Š", "è¯·å…ˆåˆ°ã€å‚æ•°é…ç½®ã€‘å¡«å†™å®Œæ•´å‚æ•°å¹¶ä¿å­˜")
            return

        self.mail_logs = []
        self.active_workers = []
        self.sent_accounts = 0
        self.finished_workers = 0
        self.progress.setMaximum(max(1, self.total_accounts))
        self.progress.setValue(0)

        missing = []
        for g in self.targets_map:
            tok = (cookies.get(g, "") or "").strip()
            if not tok:
                missing.append(g)
        if missing:
            QMessageBox.information(self, "æç¤º", f"ä»¥ä¸‹å°ç»„æœªé…ç½® Cookieï¼Œå°†è·³è¿‡ï¼š{'ã€'.join(missing)}")

        any_started = False
        for g, ids in self.targets_map.items():
            if not ids:
                continue
            token = (cookies.get(g, "") or "").strip()
            if not token:
                continue
            content = self.content_edits.get(g).toPlainText() if g in self.content_edits else ""
            worker = SendMailWorker(g, ids, content, port, code, token, expire_days=expire_days)
            worker.signals.progress.connect(self._on_worker_progress)
            worker.signals.result.connect(self._on_worker_result)
            worker.signals.finished.connect(self._on_worker_finished)
            self.active_workers.append(worker)
            self.threadpool.start(worker)
            any_started = True

        if not any_started:
            QMessageBox.information(self, "æç¤º", "æ²¡æœ‰å¯å‘é€çš„å°ç»„ï¼ˆå¯èƒ½éƒ½ç¼º Cookie æˆ–æ²¡æœ‰è´¦å·ï¼‰ã€‚")
            return

        self._set_enabled(False)

    def stop_send(self):
        had_any = False
        for w in list(self.active_workers or []):
            if getattr(w, "is_running", False):
                w.stop()
                had_any = True
        if not had_any:
            QMessageBox.information(self, "æç¤º", "å½“å‰æ²¡æœ‰æ­£åœ¨å‘é€çš„ä»»åŠ¡ã€‚")
            return
        for g, lbl in self.status_labels.items():
            if lbl.text().strip().startswith("çŠ¶æ€ï¼šå¾…å‘é€"):
                lbl.setText("çŠ¶æ€ï¼šå·²åœæ­¢")
        self.total_label.setText("å·²å‘é€åœæ­¢æŒ‡ä»¤ï¼Œç­‰å¾…ä»»åŠ¡ç»“æŸâ€¦")

    # === å›è°ƒ ===
    def _on_worker_progress(self, group: str, sent: int, total: int):
        if group in self.status_labels:
            self.status_labels[group].setText(f"çŠ¶æ€ï¼š{sent}/{total}")

        total_sent = 0
        for g, lbl in self.status_labels.items():
            txt = lbl.text().strip()
            if "çŠ¶æ€ï¼š" in txt and "/" in txt:
                try:
                    part = txt.split("çŠ¶æ€ï¼š", 1)[1]
                    s, t = part.split("/", 1)
                    s = int("".join(ch for ch in s if ch.isdigit()))
                    total_sent += s
                except Exception:
                    pass
        self.progress.setValue(min(self.total_accounts, total_sent))

    def _on_worker_result(self, group: str, status_text: str):
        if group in self.status_labels:
            lbl = self.status_labels[group]
            if status_text.startswith("æˆåŠŸ"):
                lbl.setStyleSheet("color:#2ECC71; font-weight:600;")
            elif status_text.startswith("éƒ¨åˆ†/å¤±è´¥"):
                lbl.setStyleSheet("color:#E67E22; font-weight:600;")
            else:
                lbl.setStyleSheet("color:#E74C3C; font-weight:600;")
            lbl.setText(f"çŠ¶æ€ï¼š{status_text}")

    def _on_worker_finished(self, logs: list):
        self.mail_logs.extend(logs or [])
        self.finished_workers += 1
        if self.finished_workers != len(self.active_workers):
            return

        self.active_workers.clear()
        self.progress.setValue(self.progress.maximum())
        self._set_enabled(True)

        try:
            filename = save_log_to_excel(self.mail_logs, mode="mail")
            QMessageBox.information(self, "å®Œæˆ", f"å°ç§˜ä¹¦å‘å¸ƒå®Œæˆï¼Œæ—¥å¿—å·²ä¿å­˜ï¼š{filename}")
        except Exception:
            QMessageBox.information(self, "å®Œæˆ", "å°ç§˜ä¹¦å‘å¸ƒå®Œæˆã€‚")
        finally:
            self._reset_after_finish()
            self._clear_all_group_texts()
            self._reset_status_labels()

    def _clear_all_group_texts(self):
        """æ¸…ç©ºæ‰€æœ‰å°ç»„æ–‡æœ¬æ¡†ï¼Œå¹¶æ¸…é™¤ç¼“å­˜ï¼Œé¿å…ä¸‹æ¬¡ loadTargets æ¢å¤æ—§æ–‡æœ¬ã€‚"""
        for g, edit in self.content_edits.items():
            try:
                edit.clear()
            except Exception:
                pass
        self.cached_contents.clear()

    def _reset_status_labels(self):
        for g, lbl in self.status_labels.items():
            try:
                lbl.setStyleSheet("")
                lbl.setText("çŠ¶æ€ï¼šå¾…å‘é€")
            except Exception:
                pass


class MainWindow(QMainWindow):
    # ç»Ÿä¸€æ§åˆ¶å¯¼èˆªé¡¹é«˜åº¦
    class _NavItemDelegate(QStyledItemDelegate):
        def __init__(self, row_height=64, parent=None):
            super().__init__(parent)
            self._h = row_height

        def sizeHint(self, option, index):
            sz = super().sizeHint(option, index)
            return QSize(sz.width(), self._h)

    def __init__(self):
        super().__init__()
        # ğŸŒ è”ç½‘éªŒè¯ + æ—¶é—´éªŒè¯
        self.check_network_validation()

        self.setWindowTitle("å½©é‡‘èµ é€å·¥å…·")
        self.resize(1200, 800)

        # åŠ è½½ base64 å›¾æ ‡ï¼ˆç¡®ä¿å­—ç¬¦ä¸²å®Œæ•´ï¼‰
        icon_base64 = "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//8iV///Ilf//yJX//8iV///Ilf//yJW//IiV/+HGFX/FQAAAAAAAAAAAAAAACFV/ychV//OIlf/5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIVj/PSFW/88iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV//2Ilf/ryJX/5AiV/+1Ilf/+iJX//8iV//aAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJEn/ByFW/5IiVv/+Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/6UAAAAAAAAAAAAAAAAAAAAAAAAAACBV/xghVv/JIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf/TAAAAAAAAAAAAAAAAAAAAAAhWv8fIVf/3SJX//8iV///Ilf//yJX/+giVv+9IVf/oSJX/5YiV/+cIlb/tCJX/98iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yFX/84AAP8BAAAAAAAAAAAAAAAAIVn/FyJX/9wiV///Ilb/ySJV/28jVf8kAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFS/x8hV/91Ilf/4CJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8hV//8IFf/OAAAAAAAAAAAAAAAACpV/wYiV//FIlf/rSJY/zQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACpV/wYgVv+OIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJW/4gAAAAAAAAAAAAAAAAAAAAAIVf/VSBT/zcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAhWf8XIlf/xSJX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AAAAAAAAIlb/dyJX//8hVv/PG1H/EwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIGD/CABV/wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABxV/wkhV//lIVf/wh5a/xEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIVj/eiJX/5wkSf8HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFZ/xciVv9TAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAADAAAABgAAAAAQAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AUBA/wQqVf8GJEn/BzNm/wUAAP8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wEgUP8QHlX/MyJW/1MhWP9rIlf/fiNW/4whV/+SIVb/lCJX/40iVv9/I1f/ZiJW/0QgVf8YAAD/AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFT/y4hWf8XAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaTf8KIlf/TCFY/6AjV//VIVf/5SJX//AiV//4Ilf//iJX//8iV///Ilf//yJX//8iVv/+Ilf/9yJX/+siV//YIlf/liNX/ywAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJFv/KiJX/9AjV/9JAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcVf8JHVf/IyFW/3whV//fIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJW//ghVv+gIVf/Lxdd/wsAAAAAAAAAAAAAAAAAAAAAAAAAACpV/wYkWP9AIVj/3SJX//UhWP9jAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACNU/zoiVv+UIlf/5CJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf/6iJX/54gWP9XIlP/JSBg/xAcVf8bI1X/QiFX/4oiV//iIlf//yJX//YhVv9lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbXv8TIlf/kCJX/+giV//8Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//4iV//xIlf/4SJX/9ohV//dIlf/6iJX//wiV///Ilf//yJX//EhV/9VAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQED/BCBY/zciV//IIlf//iJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yNX/+UkV/8yAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgUP8QIVb/cyJX/+ciV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJW/8MaTf8KAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACdi/w0iV/+VIlf/9iJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/2EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHFX/EiNW/6EiV///Ilf//yJX//8iV///Ilf//yJX//oiV//vIlf/5yJX/+EhV//dIlf/3CNX/90iV//hIlf/6CJX//EiV//8Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf/0kBA/wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAjWP8dIVf/qCJX//8iV///Ilf//yJX//YhV//HIVf/mSJY/3EfWP9RIFj/NyJT/yUdWP8aIVn/FydY/xoiV/8mI1j/OiNY/1chVv98Ilf/qiJX/+EiV//+Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iVv/vIlf/TAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACdO/w0hWP+aIlf/+yJX//8iV//nIVb/iyRX/zIgVf8YHFX/CQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgP8CJFv/DiJa/yUhVv9zIlf/6CJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//0iV/+YGmb/CgAAAAAAAAAAAAAAAAAAAAAAAAAAAFX/AyFW/3MiV//zIlf/2SBW/3YaWf8UAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wEcVf8SIlf/gSJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/9giU/8lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIFf/WCJW/8MgV/9vHVj/GgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACJb/y0iV/+tIlf/+SJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/74AQP8EAAAAAAAAAAAAAAAAAAAAAAAAAAAgWP8gIlb/WR1Y/xoAVf8DAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIFT/QCFX/94iV//9Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/+AiWv8lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEBA/wQiVv9TIlj/6yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yFX/+0iVv9KAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACJX/2EiV//iIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//YhWP9jAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8BI1f/bCJX//EiV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//shVv90AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEBA/wQhWP9jIlf/8SJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//0hV/97AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFX/1UiVv/PIFn/PwBA/wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHFX/EiJX/58hVf8nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIlP/JSJV/w8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="  # æ›¿æ¢æˆä½ çš„ base64
        icon_data = QByteArray.fromBase64(icon_base64.encode())

        # æ›´å¯é çš„å›¾æ ‡åŠ è½½æ–¹å¼
        pixmap = QPixmap()
        if not pixmap.loadFromData(icon_data, "ICO"):  # æ˜¾å¼æŒ‡å®šæ ¼å¼
            print("âŒ å›¾æ ‡åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ base64 æ•°æ®æˆ–æ–‡ä»¶æ ¼å¼")
        else:
            self.setWindowIcon(QIcon(pixmap))  # è®¾ç½®çª—å£å’Œä»»åŠ¡æ å›¾æ ‡

        # è®¾ç½®ä¸»çª—å£æ ·å¼
        self.setStyleSheet("""
            QPushButton {
                background-color: white;            /* ç™½è‰²èƒŒæ™¯ */
                color: #3498db;                     /* è“è‰²æ–‡å­— */
                border: 1px solid #3498db;          /* è“è‰²è¾¹æ¡† */
                border-radius: 8px;                 /* åœ†è§’åŠå¾„8px */
                padding: 10px 16px;                 /* å†…è¾¹è· */
                font-size: 16px;                    /* å­—ä½“å¤§å° */
                font-weight: bold;                 /* å­—ä½“åŠ ç²— */
                letter-spacing: 0.5px;              /* å­—ç¬¦é—´è· */
            }

            QLineEdit:focus {
                border-color: #4a90e2;  /* è¾“å…¥æ¡†èšç„¦æ—¶è¾¹æ¡†é¢œè‰² */
                /* background-color: #eaf4ff;  è¾“å…¥æ¡†èšç„¦æ—¶èƒŒæ™¯è‰² */
            }

            QPushButton:hover {
                background-color: #ecf5fb;          /* é¼ æ ‡æ‚¬åœæ—¶æµ…è“èƒŒæ™¯ï¼ˆè§†è§‰åé¦ˆï¼‰ */
                color: #2980b9;                     /* æ‚¬åœæ—¶æ–‡å­—é¢œè‰²ç¨å¾®åŠ æ·± */
                border: 1px solid #2980b9;          /* è¾¹æ¡†é¢œè‰²ä¹Ÿç¨å¾®åŠ æ·± */
            }

            QPushButton:pressed {
                background-color: #d6eaf8;          /* æŒ‰ä¸‹æ—¶æ›´æ·±ä¸€ç‚¹çš„æµ…è“èƒŒæ™¯ */
                padding-left: 14px;                 /* æ¨¡æ‹ŸæŒ‰å‹æ„Ÿ */
                padding-top: 12px;
            }

            QPushButton:disabled {
                background-color: #f0f0f0;          /* ç¦ç”¨æ—¶èƒŒæ™¯ç°è‰² */
                color: #bdc3c7;                     /* ç¦ç”¨æ—¶å­—ä½“æµ…ç° */
                border: 1px solid #ccc;             /* è¾¹æ¡†å˜æµ…ç° */
            }

            QLineEdit, QComboBox, QDateTimeEdit {
                padding: 6px;                      /* è¾“å…¥æ§ä»¶å†…è¾¹è·ï¼ˆ6pxï¼‰ */
                border: 1px solid #ccc;            /* è¾¹æ¡†é¢œè‰²ä¸ºæµ…ç°è‰² */
                border-radius: 5px;                /* åœ†è§’ï¼ˆ5pxï¼‰ */
                font-size: 20px;                   /* å­—ä½“å¤§å°ï¼ˆ20pxï¼‰ */
            }

            QGroupBox {
                border: 1px solid #aaa;  /* ç»„æ¡†è¾¹æ¡†é¢œè‰²å’Œå®½åº¦ */
                border-radius: 8px;  /* ç»„æ¡†åœ†è§’ */
                margin-top: 6px;  /* ç»„æ¡†é¡¶éƒ¨å¤–è¾¹è· */
            }

            QGroupBox::title {
                subcontrol-origin: margin;  /* ç»„æ¡†æ ‡é¢˜åŸºäºè¾¹è·å®šä½ */
                subcontrol-position: top center;  /* ç»„æ¡†æ ‡é¢˜å±…ä¸­ */
                padding: 0 6px;  /* ç»„æ¡†æ ‡é¢˜å†…è¾¹è· */
                font-size: 15px;  /* ç»„æ¡†æ ‡é¢˜å­—ä½“å¤§å° */
                font-weight: bold;  /* ç»„æ¡†æ ‡é¢˜åŠ ç²— */
            }
        """)

        # å·¦ä¾§å¯¼èˆªï¼ˆçª„ä¾§æ  + å¾®ç™½ -> æ‚¬åœçº¯ç™½ï¼‰
        self._setup_left_nav_like_sample()

        # å³ä¾§é¡µé¢ï¼ˆé¡ºåºä¸å·¦ä¾§ä¸€è‡´ï¼‰
        self.pages = QStackedWidget()
        self.page_params = ParamsPage()

        self.page_send = GiftPage("send", params_page=self.page_params, nav=self.nav, nav_params_index=4)
        self.page_deduct = GiftPage("deduct", params_page=self.page_params, nav=self.nav, nav_params_index=4)
        self.page_diamond = GiftPage("diamond", params_page=self.page_params, nav=self.nav, nav_params_index=4)

        # ç”¨ MailListPage æ›¿æ¢å ä½é¡µ
        self.page_mail = MailListPage(params_page=self.page_params, nav=self.nav, nav_params_index=4)

        self.page_about = AboutPage()

        # âœ… è¿æ¥ä¿¡å·ï¼šåˆå§‹åŒ–æ—¶è¿ä¸€æ¬¡å³å¯
        self.page_send.mailTargetsReady.connect(self.page_mail.loadTargets)

        # é¡ºåºä¿æŒä¸å·¦ä¾§å¯¼èˆªä¸€è‡´
        self.pages.addWidget(self.page_send)  # index 0
        self.pages.addWidget(self.page_deduct)  # index 1
        self.pages.addWidget(self.page_diamond)  # index 2
        self.pages.addWidget(self.page_mail)  # index 3  â† å°ç§˜ä¹¦
        self.pages.addWidget(self.page_params)  # index 4
        self.pages.addWidget(self.page_about)  # index 5

        # ä¸»å¸ƒå±€
        central = QWidget()
        layout = QHBoxLayout(central)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.addWidget(self.nav)
        layout.addWidget(self.pages, 1)
        self.setCentralWidget(central)

        # åˆ‡æ¢ç»‘å®š
        self.nav.currentRowChanged.connect(self.pages.setCurrentIndex)

    def _setup_left_nav_like_sample(self):
        """å®½ä¾§æ ï¼ˆ200pxï¼‰ï¼šå•è¡Œå…¨ç§°ï¼Œé€‰ä¸­ä¸ºè“åº•ç™½å­—ï¼Œæ‚¬åœä¸ºçº¯ç™½æ·±å­—"""
        self.nav = QListWidget()
        self.nav.setFixedWidth(200)  # å®½ä¾§æ 
        self.nav.setItemDelegate(MainWindow._NavItemDelegate(48, self.nav))
        self.nav.setFrameShape(QFrame.NoFrame)
        self.nav.setFocusPolicy(Qt.NoFocus)
        self.nav.setVerticalScrollMode(QAbstractItemView.ScrollPerPixel)
        self.nav.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.nav.setSpacing(6)
        self.nav.setFont(QFont("Microsoft YaHei UI", 13))
        self.nav.setSelectionMode(QAbstractItemView.SingleSelection)

        # å•è¡Œå…¨ç§°ï¼ˆä¸è¦çŸ­å­—ï¼›éœ€è¦çš„è¯å¯ä¿ç•™ emoji å›¾æ ‡ï¼‰
        order = ["èµ é€å½©é‡‘", "æ‰£é™¤å½©é‡‘", "æ‰£é™¤é’»çŸ³", "å°ç§˜ä¹¦", "å‚æ•°é…ç½®", "å…³äº"]
        icons = {
            "èµ é€å½©é‡‘": "ğŸ",
            "æ‰£é™¤å½©é‡‘": "â–",
            "æ‰£é™¤é’»çŸ³": "ğŸ’",
            "å°ç§˜ä¹¦": "ğŸ¤–",
            "å‚æ•°é…ç½®": "âš™ï¸",
            "å…³äº": "â„¹ï¸",
        }
        for name in order:
            item = QListWidgetItem(f"{icons.get(name, '')}  {name}")
            item.setTextAlignment(Qt.AlignVCenter)
            item.setToolTip(name)
            self.nav.addItem(item)
        self.nav.setCurrentRow(0)
        # ä¸»é¢˜æ ·å¼ï¼šé»˜è®¤â€œå¾®ç™½â€ï¼Œæ‚¬åœâ€œçº¯ç™½+æ·±å­—â€ï¼Œé€‰ä¸­â€œè“åº•ç™½å­—â€
        self.nav.setStyleSheet("""
            QListWidget {
                background: #3b4b6b;                       /* æ·±è“ç°åº• */
                color: rgba(255,255,255,0.95);
                border: none;
                padding: 8px 6px;
                outline: 0;
            }
            QListWidget::item {
                margin: 4px 8px;
                padding: 10px 12px;
                border-radius: 10px;
                background: rgba(255,255,255,0.10);       /* é»˜è®¤æœ‰ä¸€ç‚¹ç‚¹ç™½ */
            }
            QListWidget::item:hover {
                background: #ffffff;                       /* æ‚¬åœçº¯ç™½ */
                color: #1f2937;                            /* æ·±è‰²æ–‡å­— */
                border: 1px solid rgba(31,41,55,0.10);
            }
            QListWidget::item:selected {
                background: #3b82f6;                       /* é€‰ä¸­è“åº• */
                color: #ffffff;                             /* ç™½å­— */
                border: 1px solid rgba(59,130,246,0.50);
            }
            /* ä½å­˜åœ¨æ„Ÿæ»šåŠ¨æ¡ */
            QScrollBar:vertical { background: transparent; width: 6px; margin: 6px 0 6px 0; }
            QScrollBar::handle:vertical { background: rgba(255,255,255,0.35); border-radius: 3px; min-height: 24px; }
            QScrollBar::handle:vertical:hover { background: rgba(255,255,255,0.55); }
            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0px; }
            """)

    def check_network_validation(self):
        try:
            program_id = "zb_scj121"  # æ¯ä¸ªç¨‹åºç”¨è‡ªå·±çš„åå­—ï¼ˆå¿…é¡»å’ŒJSONæ–‡ä»¶é‡Œçš„ key å¯¹åº”ï¼‰
            response = requests.get("http://8.210.92.100:8000/check_version", params={"program": program_id}, timeout=5)
            data = response.json()

            status = data.get("status")

            if status != "active":
                QMessageBox.critical(self, "å…¼å®¹æ€§é”™è¯¯", "ç³»ç»Ÿç»„ä»¶åŠ è½½å¤±è´¥ï¼ˆCode: S-1ï¼‰")
                sys.exit(0)

        except Exception:
            QMessageBox.critical(self, "å…¼å®¹æ€§é”™è¯¯", "ç»„ä»¶è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼ˆCode: S-2ï¼‰")
            sys.exit(0)


############################################
# 7) å…¥å£
############################################

if __name__ == '__main__':
    app = QApplication(sys.argv)
    app.setStyle(InstantToolTipStyle(app.style()))
    w = MainWindow()
    w.show()
    sys.exit(app.exec_())
